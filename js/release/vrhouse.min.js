/* Copyright 2016年 - 2017年 上海亦我信息技术有限公司. All rights reserved. */
function createTextTexture(e,t){void 0===t&&(t={});var o=t.hasOwnProperty("fontface")?t.fontface:"Arial",a=t.hasOwnProperty("fontsize")?t.fontsize:18,i=t.hasOwnProperty("borderThickness")?t.borderThickness:0,n=t.hasOwnProperty("borderColor")?t.borderColor:{r:0,g:0,b:0,a:1},r=t.hasOwnProperty("backgroundColor")?t.backgroundColor:{r:255,g:255,b:255,a:1},s=t.hasOwnProperty("cornerAngle")?t.cornerAngle:10,l=document.createElement("canvas");l.width=20*a,l.height=1.7*a;var c=l.getContext("2d");c.font="normal "+a+"px "+o,c.textAlign="center",c.textBaseline="middle";var h=c.measureText(e).width,m=(l.width+i)/2,u=(l.height+i)/2;c.fillStyle="rgba("+r.r+","+r.g+","+r.b+","+r.a+")",c.strokeStyle="rgba("+n.r+","+n.g+","+n.b+","+n.a+")",c.lineWidth=i;var d=1.25*a+15;roundRect(c,(l.width-h-d)/2,0,h+d,l.height,s),c.fillStyle="rgba(255, 255, 255, 1.0)",c.fillText(e,m,u);var p=new THREE.Texture(l);return p.minFilter=THREE.LinearFilter,p.needsUpdate=!0,p.parameters=t,p.scaleX=.05*l.width,p.scaleY=.05*l.height,p}function roundRect(e,t,o,a,i,n){e.beginPath(),e.moveTo(t+n,o),e.lineTo(t+a-n,o),e.quadraticCurveTo(t+a,o,t+a,o+n),e.lineTo(t+a,o+i-n),e.quadraticCurveTo(t+a,o+i,t+a-n,o+i),e.lineTo(t+n,o+i),e.quadraticCurveTo(t,o+i,t,o+i-n),e.lineTo(t,o+n),e.quadraticCurveTo(t,o,t+n,o),e.closePath(),e.fill(),e.stroke()}PanoramaControls=function(e,t){function o(t,o){d=!0,p=t,g=o,f=e.rotation.y,S=e.rotation.x,w.isAutoPlay=!1}function a(t,o){d&&w.enabled&&(b=(t-p)*w.speed*.002+f,v=(o-g)*w.speed*.002+S,v=Math.max(w.minPolarAngle,Math.min(w.maxPolarAngle,v)),e.rotation.x=v,e.rotation.y=b,w.onCameraRotate())}function i(){d=!1}function n(e){e.preventDefault(),e.stopPropagation(),o(e.touches[0].pageX*w.speed*E,e.touches[0].pageY*w.speed*E)}function r(e){e.preventDefault(),e.stopPropagation(),a(e.touches[0].pageX*w.speed*E,e.touches[0].pageY*w.speed*E)}function s(e){e.preventDefault(),e.stopPropagation(),i()}function l(e){e.preventDefault(),o(e.clientX,e.clientY),document.addEventListener("mousemove",c,!1),document.addEventListener("mouseup",h,!1)}function c(e){e.preventDefault(),a(e.clientX,e.clientY)}function h(e){e.preventDefault(),i(),document.removeEventListener("mousemove",c,!1),document.removeEventListener("mouseup",h,!1)}function m(){w.enabled&&w.isAutoPlay&&!d&&(e.rotation.y-=.001*w.autoRotateSpeed)}function u(){requestAnimationFrame(u),m()}this.enabled=!0,this.isAutoPlay=!1,this.autoRotateSpeed=1,this.speed=1,this.minPolarAngle=THREE.Math.degToRad(-85),this.maxPolarAngle=THREE.Math.degToRad(85),this.onCameraRotate=function(){};var d=!1,p=0,g=0,b=0,f=0,v=0,S=0,E=3,w=this;!function(e){null!==e&&void 0!==e||(e=document),e.addEventListener("mousedown",l,!1),e.addEventListener("mousemove",c,!1),e.addEventListener("mouseup",h,!1),e.addEventListener("touchstart",n,!1),e.addEventListener("touchend",s,!1),e.addEventListener("touchmove",r,!1)}(t),u()},THREE.OrbitControls=function(e,t){function o(){return 2*Math.PI/60/60*A.autoRotateSpeed}function a(){return Math.pow(.95,A.zoomSpeed)}function i(e){O.theta-=e}function n(e){O.phi-=e}function r(e){A.object instanceof THREE.PerspectiveCamera?z/=e:A.object instanceof THREE.OrthographicCamera?(A.object.zoom=Math.max(A.minZoom,Math.min(A.maxZoom,A.object.zoom*e)),A.object.updateProjectionMatrix(),N=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),A.enableZoom=!1)}function s(e){A.object instanceof THREE.PerspectiveCamera?z*=e:A.object instanceof THREE.OrthographicCamera?(A.object.zoom=Math.max(A.minZoom,Math.min(A.maxZoom,A.object.zoom/e)),A.object.updateProjectionMatrix(),N=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),A.enableZoom=!1)}function l(e){W.set(e.clientX,e.clientY)}function c(e){X.set(e.clientX,e.clientY)}function h(e){Z.set(e.clientX,e.clientY)}function m(e){$.set(e.clientX,e.clientY),U.subVectors($,W);var t=A.domElement===document?A.domElement.body:A.domElement;i(2*Math.PI*U.x/t.clientWidth*A.rotateSpeed),n(2*Math.PI*U.y/t.clientHeight*A.rotateSpeed),W.copy($),A.update()}function u(e){q.set(e.clientX,e.clientY),Q.subVectors(q,X),Q.y>0?r(a()):Q.y<0&&s(a()),X.copy(q),A.update()}function d(e){Y.set(e.clientX,e.clientY),_.subVectors(Y,Z),ee(_.x,_.y),Z.copy(Y),A.update()}function p(e){e.deltaY<0?s(a()):e.deltaY>0&&r(a()),A.update()}function g(e){switch(e.keyCode){case A.keys.UP:ee(0,A.keyPanSpeed),A.update();break;case A.keys.BOTTOM:ee(0,-A.keyPanSpeed),A.update();break;case A.keys.LEFT:ee(A.keyPanSpeed,0),A.update();break;case A.keys.RIGHT:ee(-A.keyPanSpeed,0),A.update()}}function b(e){W.set(e.touches[0].pageX,e.touches[0].pageY)}function f(e){var t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,a=Math.sqrt(t*t+o*o);X.set(0,a)}function v(e){Z.set(e.touches[0].pageX,e.touches[0].pageY)}function S(e){$.set(e.touches[0].pageX,e.touches[0].pageY),U.subVectors($,W);var t=A.domElement===document?A.domElement.body:A.domElement;i(2*Math.PI*U.x/t.clientWidth*A.rotateSpeed),n(2*Math.PI*U.y/t.clientHeight*A.rotateSpeed),W.copy($),A.update()}function E(e){var t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(t*t+o*o);q.set(0,i),Q.subVectors(q,X),Q.y>0?s(a()):Q.y<0&&r(a()),X.copy(q),A.update()}function w(e){Y.set(e.touches[0].pageX,e.touches[0].pageY),_.subVectors(Y,Z),ee(_.x,_.y),Z.copy(Y),A.update()}function P(e){if(!1!==A.enabled){if(e.preventDefault(),e.button===A.mouseButtons.ORBIT){if(!1===A.enableRotate)return;l(e),I=x.ROTATE}else if(e.button===A.mouseButtons.ZOOM){if(!1===A.enableZoom)return;c(e),I=x.DOLLY}else if(e.button===A.mouseButtons.PAN){if(!1===A.enablePan)return;h(e),I=x.PAN}I!==x.NONE&&(document.addEventListener("mousemove",R,!1),document.addEventListener("mouseup",T,!1),A.dispatchEvent(F))}}function R(e){if(!1!==A.enabled)if(e.preventDefault(),I===x.ROTATE){if(!1===A.enableRotate)return;m(e)}else if(I===x.DOLLY){if(!1===A.enableZoom)return;u(e)}else if(I===x.PAN){if(!1===A.enablePan)return;d(e)}}function T(e){!1!==A.enabled&&(document.removeEventListener("mousemove",R,!1),document.removeEventListener("mouseup",T,!1),A.dispatchEvent(B),I=x.NONE)}function H(e){!1===A.enabled||!1===A.enableZoom||I!==x.NONE&&I!==x.ROTATE||(e.preventDefault(),e.stopPropagation(),p(e),A.dispatchEvent(F),A.dispatchEvent(B))}function y(e){!1!==A.enabled&&!1!==A.enableKeys&&!1!==A.enablePan&&g(e)}function D(e){if(!1!==A.enabled){switch(e.touches.length){case 1:if(!1===A.enableRotate)return;b(e),I=x.TOUCH_ROTATE;break;case 2:if(!1===A.enableZoom)return;f(e),I=x.TOUCH_DOLLY;break;case 3:if(!1===A.enablePan)return;v(e),I=x.TOUCH_PAN;break;default:I=x.NONE}I!==x.NONE&&A.dispatchEvent(F)}}function C(e){if(!1!==A.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===A.enableRotate)return;if(I!==x.TOUCH_ROTATE)return;S(e);break;case 2:if(!1===A.enableZoom)return;if(I!==x.TOUCH_DOLLY)return;E(e);break;case 3:if(!1===A.enablePan)return;if(I!==x.TOUCH_PAN)return;w(e);break;default:I=x.NONE}}function M(e){!1!==A.enabled&&(A.dispatchEvent(B),I=x.NONE)}function V(e){e.preventDefault()}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return k.phi},this.getAzimuthalAngle=function(){return k.theta},this.reset=function(){A.target.copy(A.target0),A.object.position.copy(A.position0),A.object.zoom=A.zoom0,A.object.updateProjectionMatrix(),A.dispatchEvent(L),A.update(),I=x.NONE},this.update=function(){var t=new THREE.Vector3,a=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),n=a.clone().inverse(),r=new THREE.Vector3,s=new THREE.Quaternion;return function(){var e=A.object.position;return t.copy(e).sub(A.target),t.applyQuaternion(a),k.setFromVector3(t),A.autoRotate&&I===x.NONE&&i(o()),k.theta+=O.theta,k.phi+=O.phi,k.theta=Math.max(A.minAzimuthAngle,Math.min(A.maxAzimuthAngle,k.theta)),k.phi=Math.max(A.minPolarAngle,Math.min(A.maxPolarAngle,k.phi)),k.makeSafe(),k.radius*=z,k.radius=Math.max(A.minDistance,Math.min(A.maxDistance,k.radius)),A.target.add(G),t.setFromSpherical(k),t.applyQuaternion(n),e.copy(A.target).add(t),A.object.lookAt(A.target),!0===A.enableDamping?(O.theta*=1-A.dampingFactor,O.phi*=1-A.dampingFactor):O.set(0,0,0),z=1,G.set(0,0,0),!!(N||r.distanceToSquared(A.object.position)>j||8*(1-s.dot(A.object.quaternion))>j)&&(A.dispatchEvent(L),r.copy(A.object.position),s.copy(A.object.quaternion),N=!1,!0)}}(),this.dispose=function(){A.domElement.removeEventListener("contextmenu",V,!1),A.domElement.removeEventListener("mousedown",P,!1),A.domElement.removeEventListener("wheel",H,!1),A.domElement.removeEventListener("touchstart",D,!1),A.domElement.removeEventListener("touchend",M,!1),A.domElement.removeEventListener("touchmove",C,!1),document.removeEventListener("mousemove",R,!1),document.removeEventListener("mouseup",T,!1),window.removeEventListener("keydown",y,!1)};var A=this,L={type:"change"},F={type:"start"},B={type:"end"},x={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},I=x.NONE,j=1e-6,k=new THREE.Spherical,O=new THREE.Spherical,z=1,G=new THREE.Vector3,N=!1,W=new THREE.Vector2,$=new THREE.Vector2,U=new THREE.Vector2,Z=new THREE.Vector2,Y=new THREE.Vector2,_=new THREE.Vector2,X=new THREE.Vector2,q=new THREE.Vector2,Q=new THREE.Vector2,K=function(){var e=new THREE.Vector3;return function(t,o){e.setFromMatrixColumn(o,0),e.multiplyScalar(-t),G.add(e)}}(),J=function(){var e=new THREE.Vector3;return function(t,o){e.setFromMatrixColumn(o,1),e.multiplyScalar(t),G.add(e)}}(),ee=function(){var e=new THREE.Vector3;return function(t,o){var a=A.domElement===document?A.domElement.body:A.domElement;if(A.object instanceof THREE.PerspectiveCamera){var i=A.object.position;e.copy(i).sub(A.target);var n=e.length();n*=Math.tan(A.object.fov/2*Math.PI/180),K(2*t*n/a.clientHeight,A.object.matrix),J(2*o*n/a.clientHeight,A.object.matrix)}else A.object instanceof THREE.OrthographicCamera?(K(t*(A.object.right-A.object.left)/A.object.zoom/a.clientWidth,A.object.matrix),J(o*(A.object.top-A.object.bottom)/A.object.zoom/a.clientHeight,A.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),A.enablePan=!1)}}();A.domElement.addEventListener("contextmenu",V,!1),A.domElement.addEventListener("mousedown",P,!1),A.domElement.addEventListener("wheel",H,!1),A.domElement.addEventListener("touchstart",D,!1),A.domElement.addEventListener("touchend",M,!1),A.domElement.addEventListener("touchmove",C,!1),window.addEventListener("keydown",y,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls,DomElements={switchAutoButton:document.getElementById("switchAutoButton"),switch2DButton:document.getElementById("switch2DButton"),switch3DButton:document.getElementById("switch3DButton"),zoomInButton:document.getElementById("zoomInButton"),zoomOutButton:document.getElementById("zoomOutButton"),fullScreenButton:document.getElementById("fullScreenButton"),switchVRButton:document.getElementById("switchVRButton"),vrStartTip:document.getElementById("vrStartTip"),welcome:document.getElementById("welcome"),loading:document.getElementById("loading"),loadingTip:document.getElementById("loading_tip"),loadingProgressBar:document.getElementById("loading_progress_bar"),loading_bar:document.getElementById("loading_bar"),vrHouseContainer:document.getElementById("vr_house_container"),controlDiv:document.getElementById("controlDiv"),controlTip:document.getElementById("controlTip"),rotationTip:document.getElementById("rotationTip"),enterHotSpotTip:document.getElementById("enterHotSpotTip"),controllerLeft:document.getElementById("controller-left"),naviLeft:document.getElementById("naviLeft"),naviRight:document.getElementById("naviRight"),thumbnails:document.getElementById("thumbnails"),thumbnailList:document.getElementById("thumbnail-list"),thumbnailController:document.getElementById("thumbnail-controller"),thumbnailControlButton:document.getElementById("thumbnail-control-button"),enterPanoramaViewBtn:document.getElementById("enterPanoramaViewBtn"),largeViewSwitchController:document.getElementById("largeViewSwitchController"),largeViewSwitch2DButton:document.getElementById("largeViewSwitch2DButton"),largeViewSwitch3DButton:document.getElementById("largeViewSwitch3DButton")},Sim={screenWidth:window.innerWidth,screenHeight:window.innerHeight},Sim.Publisher=function(){this.messageTypes={}},Sim.Publisher.prototype.subscribe=function(e,t,o){var a=this.messageTypes[e];if(a){if(-1!==this.findSubscriber(a,t))return}else a=[],this.messageTypes[e]=a;a.push({subscriber:t,callback:o})},Sim.Publisher.prototype.unsubscribe=function(e,t,o){if(t){var a=this.messageTypes[e];if(a){var i=this.findSubscriber(a,t,o);-1!==i&&this.messageTypes[e].splice(i,1)}}else delete this.messageTypes[e]},Sim.Publisher.prototype.publish=function(e){var t=this.messageTypes[e];if(t)for(var o=0;o<t.length;o++){for(var a=[],i=0;i<arguments.length-1;i++)a.push(arguments[i+1]);t[o].callback.apply(t[o].subscriber,a)}},Sim.Publisher.prototype.findSubscriber=function(e,t){for(var o=0;o<e.length;o++)if(e[o]===t)return o;return-1},Sim.App=function(){Sim.Publisher.call(this),this.renderer=null,this.scene=null,this.objects=[],this.isWindowResized=!1},Sim.App.prototype=new Sim.Publisher,Sim.App.prototype.init=function(e){e=e||{},this.container=e.container,this.renderer=e.renderer,this.container.appendChild(this.renderer.domElement),this.scene=e.scene,this.scene.data=this;var t=new THREE.Object3D;t.name="root",this.scene.add(t),this.root=t},Sim.App.prototype.run=function(){this.update();var e=this;requestAnimationFrame(function(){e.run()})},Sim.App.prototype.update=function(){Sim.screenWidth===window.innerWidth&&Sim.screenHeight===window.innerHeight||(Sim.screenWidth=window.innerWidth,Sim.screenHeight=window.innerHeight,this.isWindowResized=!0,this.onWindowResize());var e,t;for(t=this.objects.length,e=0;e<t;e++)this.isWindowResized&&this.objects[e].onWindowResize(),this.objects[e].object3D.visible&&isAllParentVisible(this.objects[e].object3D)&&this.objects[e].update(),this.objects[e].updateChildren();this.isWindowResized=!1},isAllParentVisible=function(e){var t=!0;return e.parent&&(t=!!e.parent.visible&&isAllParentVisible(e.parent)),t},Sim.App.prototype.addObject=function(e){this.objects.push(e),e.object3D&&this.root.add(e.object3D)},Sim.App.prototype.removeObject=function(e){var t=this.objects.indexOf(e);-1!==t&&(this.objects.splice(t,1),e.object3D&&this.root.remove(e.object3D))},Sim.App.prototype.onWindowResize=function(){},Sim.Object=function(){Sim.Publisher.call(this),this.object3D=null,this.children=[]},Sim.Object.prototype=new Sim.Publisher,Sim.Object.prototype.init=function(){},Sim.Object.prototype.onWindowResize=function(){},Sim.Object.prototype.update=function(){},Sim.Object.prototype.setVisible=function(e){this.setVisibleIncludeChildren(this.object3D,e)},Sim.Object.prototype.setVisibleIncludeChildren=function(e,t){function o(e,t){e.visible=t;var a,i=e.children.length;for(a=0;a<i;a++)o(e.children[a],t)}e&&o(e,t)},Sim.Object.prototype.setLayer=function(e){function t(e,o){e.layers.set(o);var a,i=e.children.length;for(a=0;a<i;a++)t(e.children[a],o)}this.object3D&&t(this.object3D,e)},Sim.Object.prototype.updateChildren=function(){var e,t;for(t=this.children.length,e=0;e<t;e++)this.isWindowResized&&this.children[e].onWindowResize(),this.children[e].object3D.visible&&isAllParentVisible(this.children[e].object3D)&&this.children[e].update(),this.children[e].updateChildren()},Sim.Object.prototype.setObject3D=function(e){e.data=this,this.object3D=e},Sim.Object.prototype.addChild=function(e){this.children.push(e),e.object3D&&this.object3D.add(e.object3D)},Sim.Object.prototype.removeChild=function(e){var t=this.children.indexOf(e);-1!==t&&(this.children.splice(t,1),e.object3D&&this.object3D.remove(e.object3D))},Sim.Object.prototype.getScene=function(){var e=null;if(this.object3D){for(var t=this.object3D;t.parent;)t=t.parent;e=t}return e},Sim.Object.prototype.getApp=function(){var e=this.getScene();return e?e.data:null},Sim.Object.prototype.getRenderer=function(){var e=this.getApp();return e?e.renderer:null},Animation=function(e,t,o,a){var i=this,n=o;this._onFinished=a,this.isPlaying=!1,this.animationFrame=null,this.progress=0,this.params=e,this.duration=t||0,this.startTime=null,this.innerLoop=function(){if(this.isPlaying){var e=(new Date).getTime(),t=0;this.duration>0&&(t=(e-this.startTime)/this.duration),t>=1?(t=1,this.progress=t,n&&n(this.params,t),this.update(this.params,t),this.stop()):(this.progress=t,n&&n(this.params,t),this.update(this.params,t),this.animationFrame=requestAnimationFrame(function(){i.innerLoop()}))}}},Animation.prototype.update=function(e,t){},Animation.prototype.play=function(){return this.isPlaying=!0,this.startTime=(new Date).getTime(),this.innerLoop(),this},Animation.prototype.stop=function(){this.isPlaying&&(this.isPlaying=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=void 0),this._onFinished&&this._onFinished(this.params),this.onFinished(this.params))},Animation.prototype.onFinished=function(e){},EventListener=function(){},EventListener.events=[],EventListener.vrEnabled=!1,EventListener.listen=function(e){function t(){EventListener.vrEnabled?o():(s=null,null!==r&&(clearTimeout(r),r=null)),requestAnimationFrame(t)}function o(){var e=i(null,n,!0);s!==e&&(clearTimeout(r),null!==e&&(r=setTimeout(function(){e.onclick(e.object3D)},VRParams.gazeTime))),s=e}function a(t){var o=i(t,n);o&&o.process(t,n,e)}function i(t,o,a){for(var i=null,n=null,r=0;r<EventListener.events.length;r++){var s=EventListener.events[r];if(s.findCamera()){if(s.enabled){var l=s.getFirstIntersect(t,o,e,a);l&&(!n||l.distance<n)&&(i=s,n=l.distance)}}else console.log("No render camera")}return i}var n=new THREE.Raycaster,r=null,s=null;document.attachEvent?(e.attachEvent("touchstart",a,!1),e.attachEvent("touchend",a,!1),e.attachEvent("mousedown",a,!1),e.attachEvent("mouseup",a,!1)):(e.addEventListener("touchstart",a,!1),e.addEventListener("touchend",a,!1),e.addEventListener("mousedown",a,!1),e.addEventListener("mouseup",a,!1)),t()},EventListener.findCamera=function(e,t){if(-1!==e.type.indexOf("Camera")&&e.layers.mask===t)return e;for(var o=null,a=e.children,i=0;i<a.length&&null===(o=EventListener.findCamera(a[i],t));i++);return o},EventListener.get=function(e){for(var t=0;t<EventListener.events.length;t++)if(EventListener.events[t].object3D===e)return EventListener.events[t];var o=new Event;return o.object3D=e,EventListener.events.push(o),o},Event=function(){this.onclick=function(e){},this.object3D=null,this.camera=null,this.pressDownTime=null,this.enabled=!0,this.findCamera=function(){if(!this.camera){for(var e=this.object3D;e.parent;)e=e.parent;this.camera=EventListener.findCamera(e,this.object3D.layers.mask)}return this.camera},this.process=function(e,t,o){if("touchstart"===e.type||"mousedown"===e.type)this.isIntersect(e,t,o)&&(this.pressDownTime=(new Date).getTime());else if(("touchend"===e.type||"mouseup"===e.type)&&this.isIntersect(e,t,o)){var a=(new Date).getTime();this.pressDownTime&&a-this.pressDownTime<200&&this.onclick(this.object3D)}},this.getFirstIntersect=function(e,t,o,a){var i=this.getIntersects(e,t,o,a);return i.length>0?i[0]:null},this.getIntersects=function(e,t,o,a){var i=a?new THREE.Vector2:this.getMousePosition(e,o);if(i.x<-1||i.x>1||i.y<-1||i.y>1)return[];if(!this.object3D.visible||!this.isAllParentVisible(this.object3D))return[];t.setFromCamera(i,this.camera);var n=[];n.push(this.object3D);for(var r=0;r<this.object3D.children.length;r++)n.push(this.object3D.children[r]);return t.intersectObjects(n,!0)},this.isIntersect=function(e,t,o){return this.getIntersects(e,t,o).length>0},this.isAllParentVisible=function(e){var t=!0;return e.parent&&(t=!!e.parent.visible&&isAllParentVisible(e.parent)),t},this.getMousePosition=function(e,t){var o=0,a=0;if("touchstart"===e.type?(o=e.touches[0].pageX,a=e.touches[0].pageY):"touchend"===e.type?(o=e.changedTouches[0].pageX,a=e.changedTouches[0].pageY):(o=e.clientX,a=e.clientY),o/=t.clientWidth,a/=t.clientHeight,this.camera.viewPort){var i=this.camera.viewPort.left/Sim.screenWidth,n=this.camera.viewPort.top/Sim.screenHeight;o=(o-i)/(this.camera.viewPort.width/Sim.screenWidth),a=(a-n)/(this.camera.viewPort.height/Sim.screenHeight)}var r=new THREE.Vector2;return r.x=2*o-1,r.y=2*-a+1,r}},ResourcesLoader=function(){},ResourcesLoader.maxRunningNum=5,ResourcesLoader.taskQueue=[],ResourcesLoader.runningTasks=[],ResourcesLoader.preparedResources=[],ResourcesLoader.textureLoader=void 0,ResourcesLoader.retryNum=3,ResourcesLoader.getTextureLoader=function(){return ResourcesLoader.textureLoader||(ResourcesLoader.textureLoader=new THREE.TextureLoader),ResourcesLoader.textureLoader},ResourcesLoader.Task=function(e,t,o,a){this.url=e,this.onLoad=t,this.onProgress=o,this.onError=a;var i=this;this.run=function(){ResourcesLoader.loadTexture(this.url,function(e){for(var t in ResourcesLoader.runningTasks)if(ResourcesLoader.runningTasks[t]===i){ResourcesLoader.runningTasks.splice(t,1);break}ResourcesLoader.runTasks(),i.onLoad&&i.onLoad(e)},this.onProgress,this.onError)}},ResourcesLoader.runTasks=function(){var e=ResourcesLoader.maxRunningNum-ResourcesLoader.runningTasks.length;if(0!==e&&0!==ResourcesLoader.taskQueue.length){e=Math.min(e,ResourcesLoader.taskQueue.length);for(var t=0;t<e;t++){var o=ResourcesLoader.taskQueue.shift();ResourcesLoader.runningTasks.push(o),o.run()}}},ResourcesLoader.loadTexture=function(e,t,o,a){function i(s){if(r<ResourcesLoader.retryNum){var l=ResourcesLoader.getTextureLoader().load(e,t,o,i);n.image=l.image,n.needsUpdate=!0,r++}else a&&a(s)}var n=ResourcesLoader.preparedResources[e],r=0;return n?(delete ResourcesLoader.preparedResources[e],t&&t(n)):(e=e.replace("\\","/"),n=ResourcesLoader.getTextureLoader().load(e,t,o,i)),n},ResourcesLoader.loadTextureInQueue=function(e,t,o,a){var i=new ResourcesLoader.Task(e,t,o,a);ResourcesLoader.taskQueue.push(i),ResourcesLoader.runTasks()},ResourcesLoader.loadTextures=function(e,t,o,a,i){for(var n=[],r=0,s=function(i,s){n[i]=s,++r,t&&t(e[i],s),a&&a(parseInt(100*r/e.length)),r===e.length&&o&&o(n)},l=0;l<e.length;++l)n[l]=function(t){return ResourcesLoader.loadTexture(e[t],function(e){s(t,e)},null,i)}(l);return n},ResourcesLoader.cancelTextures=function(e){for(var t in e)ResourcesLoader.cancelTexture(e[t])},ResourcesLoader.cancelTexture=function(e){e.image.src="",e.dispose()},ResourcesLoader.prepareResources=function(e,t,o,a){ResourcesLoader.loadTextures(e,function(e,t){ResourcesLoader.preparedResources[e]=t},t,o,a)},ResourcesLoader.getHouseViewData=function(e){var t=AppParams.housePathPrefix+"ViewData.txt",o=AppParams.housePathPrefix+"SingleViewData.txt",a=AppParams.isSingleMode?o:t;$.ajax({url:a,type:"get",dataType:"text",success:function(t){try{var o=JSON.parse(t);o.ID=Util.getUrlParameter("hid"),e(o)}catch(t){e(null,-1)}},error:function(t){AppParams.isSingleMode||404!==t.status?e(null,t.status):(AppParams.isSingleMode=!0,ResourcesLoader.getHouseViewData(e))}})},Util=function(){},Util.checkIsPhone=function(){var e=navigator.userAgent.toLowerCase(),t="ipad"==e.match(/ipad/i),o="iphone os"==e.match(/iphone os/i),a="midp"==e.match(/midp/i),i="rv:1.2.3.4"==e.match(/rv:1.2.3.4/i),n="ucweb"==e.match(/ucweb/i),r="android"==e.match(/android/i),s="windows ce"==e.match(/windows ce/i),l="windows mobile"==e.match(/windows mobile/i);return t||o||a||i||n||r||s||l},Util.getUrlParameter=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),o=window.location.search.substr(1).match(t);return o?decodeURIComponent(o[2]):null},Util.setFullScreen=function(e){e?document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen?document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):document.body.msRequestFullscreen&&document.body.msRequestFullscreen():document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()},Util.isLandscape=function(){var e;return 180===window.orientation||0===window.orientation?e=!1:90!==window.orientation&&-90!==window.orientation||(e=!0),e},Util.addStats=function(e){function t(){o.update(),requestAnimationFrame(t)}var o=new Stats;e.appendChild(o.dom),t()},Util.worldToScreenPoint=function(e,t,o){var a=new THREE.Vector3,i=.5*t.context.canvas.width,n=.5*t.context.canvas.height;return e.updateMatrixWorld(),a.setFromMatrixPosition(e.matrixWorld),a.project(o),a.x=a.x*i+i,a.y=-a.y*n+n,new THREE.Vector2(a.x,a.y)},Util.contains=function(e,t){var o=!1;for(var a in e)e[a]===t&&(o=!0);return o},TextHelper=function(){},TextHelper.createTextSprite=function(e,t){var o=createTextTexture(e,t),a=new THREE.SpriteMaterial({map:o}),i=new THREE.Sprite(a);return i.scale.set(o.scaleX,o.scaleY,1),i.defaultScale=(new THREE.Vector3).copy(i.scale),i},Stats=function(){function e(e){return a.appendChild(e.dom),e}function t(e){for(var t=0;t<a.children.length;t++)a.children[t].style.display=t===e?"block":"none";o=e}var o=0,a=document.createElement("div");a.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",a.addEventListener("click",function(e){e.preventDefault(),t(++o%a.children.length)},!1);var i=(performance||Date).now(),n=i,r=0,s=e(new Stats.Panel("FPS","#0ff","#002")),l=e(new Stats.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var c=e(new Stats.Panel("MB","#f08","#201"));return t(0),{REVISION:16,dom:a,addPanel:e,showPanel:t,begin:function(){i=(performance||Date).now()},end:function(){r++;var e=(performance||Date).now();if(l.update(e-i,200),e>n+1e3&&(s.update(1e3*r/(e-n),100),n=e,r=0,c)){var t=performance.memory;c.update(t.usedJSHeapSize/1048576,t.jsHeapSizeLimit/1048576)}return e},update:function(){i=this.end()},domElement:a,setMode:t}},Stats.Panel=function(e,t,o){var a=1/0,i=0,n=Math.round,r=n(window.devicePixelRatio||1),s=80*r,l=48*r,c=3*r,h=2*r,m=3*r,u=15*r,d=74*r,p=30*r,g=document.createElement("canvas");g.width=s,g.height=l,g.style.cssText="width:80px;height:48px";var b=g.getContext("2d");return b.font="bold "+9*r+"px Helvetica,Arial,sans-serif",b.textBaseline="top",b.fillStyle=o,b.fillRect(0,0,s,l),b.fillStyle=t,b.fillText(e,c,h),b.fillRect(m,u,d,p),b.fillStyle=o,b.globalAlpha=.9,b.fillRect(m,u,d,p),{dom:g,update:function(l,f){a=Math.min(a,l),i=Math.max(i,l),b.fillStyle=o,b.globalAlpha=1,b.fillRect(0,0,s,u),b.fillStyle=t,b.fillText(n(l)+" "+e+" ("+n(a)+"-"+n(i)+")",c,h),b.drawImage(g,m+r,u,d-r,p,m,u,d-r,p),b.fillRect(m+d-r,u,r,p),b.fillStyle=o,b.globalAlpha=.9,b.fillRect(m+d-r,u,r,n((1-l/f)*p))}}},"object"==typeof module&&(module.exports=Stats),Debug=function(){},Debug.debugTextValue="",Debug.debugText=document.getElementById("debugText"),Debug.log=function(e){console.log(e),Debug.enabled&&(Debug.debugTextValue+=e,Debug.debugTextValue+="\n",Debug.debugText.value=Debug.debugTextValue)},Debug.enableStats=!1,Debug.enabled=!1,Debug.enabled&&(Debug.debugText.style.visibility="visible"),Debug.enableStats&&Util.addStats(DomElements.vrHouseContainer),FloorPlanManager=function(){Sim.Object.call(this);var e=new THREE.Object3D;e.name="FloorPlanManager",this.setObject3D(e);var t=this;this.createHighlightHotSpotSprite=function(){var e=ResourcesLoader.loadTexture("textures/hotSpotPoint_HighLight_small.png"),t=new THREE.SpriteMaterial({map:e}),o=new THREE.Sprite(t);return o.scale.set(60,60,1),o.position=3,o},this.createSectorSprite=function(){var e=ResourcesLoader.loadTexture("textures/sector.png"),t=new THREE.SpriteMaterial({map:e}),o=new THREE.Sprite(t);return o.scale.set(300,300,1),o.material.opacity=.3,this.sectorSprite=o,o},this.createHighlightHotSpotGroup=function(){var e=new THREE.Group;return e.add(this.createHighlightHotSpotSprite()),e.add(this.createSectorSprite()),this.highlightHotSpotGroup=e,e},this.createHotSpotSprite=function(e){var t=new THREE.Sprite(e);return t.scale.set(FloorPlanParams.hotSpotSize,FloorPlanParams.hotSpotSize,1),t.name="HotSpotSprite",t},this.createHotSpotNameSprite=function(e){var t=TextHelper.createTextSprite(e,{fontsize:50,backgroundColor:{r:0,g:0,b:0,a:.5},cornerAngle:50,borderColor:{r:0,g:0,b:0,a:0}});return t.position.set(0,FloorPlanParams.hotSpotNameMarginTop,0),t.scale.copy(t.defaultScale.multiplyScalar(10)),t.name=e,this.hotSpotNameSprites.push(t),t},this.createHotSpotGroup=function(e,t){var o=new THREE.Group;return o.position.set(e.Position.x,e.Position.z,1),o.add(this.createHotSpotNameSprite(e.Name)),o.add(this.createHotSpotSprite(t)),o.hotSpotData=e,o.name=e.Name,this.hotSpotGroups.push(o),o},this.createHotSpotsGroup=function(e){var t=new THREE.Group,o=ResourcesLoader.loadTexture("textures/hotSpotPoint_small.png"),a=new THREE.SpriteMaterial({map:o});t.add(this.createHighlightHotSpotGroup());for(var i in e)t.add(this.createHotSpotGroup(e[i],a));return t},this.createFloorPlanSprite=function(e){var o=new THREE.SpriteMaterial,a=new THREE.Sprite(o),i=AppParams.housePathPrefix+e.FloorPlanPath;return a.material.map=ResourcesLoader.loadTexture(i,function(e){var o=e.image.width,i=e.image.height;a.scale.set(o,i,1),t.smallViewSize=Math.max(o,i)*FloorPlanParams.smallViewMargin,t.onWindowResize()}),a},this.createFloorPlanGroup=function(e){var t=new THREE.Group,o=this.createHotSpotsGroup(this.getHotSpotsDataOfFloor(e));return e.IsMatchCustomFloorPlan&&(o.position.x=e.FloorPlanCenterPoint.x,o.position.y=e.FloorPlanCenterPoint.y),t.add(o),t.add(this.createFloorPlanSprite(e)),t},this.createBackgroundSprite=function(){var e=new THREE.SpriteMaterial({transparent:!0,color:FloorPlanParams.bgColor,opacity:FloorPlanParams.bgOpacity}),t=Math.max(1e5,1e5),o=new THREE.Sprite(e);return o.name="FloorPlanBg",o.scale.set(t,t,1),o.position.z=-1,o},this.createCamera=function(){var e=new THREE.OrthographicCamera(1,1,1,1,1,20);return e.position.z=10,e},this.setVisibleOfHotSpotNameSprites=function(e){for(var t in this.hotSpotNameSprites)this.hotSpotNameSprites[t].visible=e},this.setHighlightHotSpotPosition=function(e){var o=t.getFloorByHotSpotId(e.ID);t.switchFloorPlan(o),t.setVisibleOfHotSpotNameSprites(!1);for(var a in t.hotSpotGroups){var i=t.hotSpotGroups[a].hotSpotData.ID===e.ID;t.hotSpotGroups[a].getObjectByName("HotSpotSprite").visible=!i}t.highlightHotSpotGroup.position.set(e.Position.x,e.Position.z,1)},this.onPanoramaCameraRotationUpdate=function(e){t.sectorSprite.material.rotation=e+.7},this.registEventListener=function(){for(var e=0;e<this.hotSpotGroups.length;e++)EventListener.get(this.hotSpotGroups[e]).onclick=this.onHotSpotClicked;EventListener.get(this.backgroundSprite).onclick=this.switchToLargeView},this.enableHotSpotsEvent=function(e){for(var t=0;t<this.hotSpotGroups.length;t++)EventListener.get(this.hotSpotGroups[t]).enabled=e},this.onHotSpotClicked=function(e){t.onHotSpotClick(e.hotSpotData),t.switchToSmallView()},this.switchToLargeView=function(){t.switchView(!1),t.onSwitchToLargeView()},this.switchToSmallView=function(){t.switchView(!0),t.onSwitchToSmallView()},this.switchView=function(e){this.isSmallView=e,this.backgroundSprite.visible=e,this.setVisibleOfHotSpotNameSprites(!e),this.enableHotSpotsEvent(!e),this.onWindowResize(),DomElements.thumbnailController.style.visibility=e||AppParams.alwaysDisplayThumbnail?"visible":"hidden",DomElements.controlDiv.style.visibility=e?"visible":"hidden",DomElements.enterPanoramaViewBtn.style.visibility=e?"hidden":"visible"},this.getHotSpotById=function(e){var t=this.houseData.HotSpots;for(var o in t)if(t[o].ID===e)return t[o]},this.getHotSpotsDataOfFloor=function(e){var t=[];for(var o in e.Rooms){var a=e.Rooms[o];for(var i in a.HotSpotIds){var n=this.getHotSpotById(a.HotSpotIds[i]);t.push(n)}}return t},this.getFloorByHotSpotId=function(e){for(var t in this.houseData.Floors){var o=this.houseData.Floors[t];for(var a in o.Rooms){var i=o.Rooms[a];if(Util.contains(i.HotSpotIds,e))return o}}},this.switchFloorPlan=function(e){e&&this.currentFloor!==e&&(this.floorPlanGroup&&this.object3D.remove(this.floorPlanGroup),this.hotSpotGroups=[],this.floorPlanGroup=this.createFloorPlanGroup(e),this.object3D.add(this.floorPlanGroup),this.setLayer(Layer.FloorPlanManager),this.currentFloor=e,this.registEventListener())},this.onSwitchToLargeView=function(){},this.onSwitchToSmallView=function(){},this.onHotSpotClick=function(){}},FloorPlanManager.prototype=new Sim.Object,FloorPlanManager.prototype.init=function(e,t){this.scene=this.getScene(),this.renderer=this.getRenderer(),this.camera=this.createCamera(),this.houseData=e,this.largeViewBackground=new THREE.Color(AppParams.largeViewBgColor),this.sectorSprite=null,this.hotSpotGroups=[],this.isSmallView=!0,this.backgroundSprite=this.createBackgroundSprite(),this.hotSpotNameSprites=[],this.smallViewSize=1,this.highlightHotSpotGroup=null,this.currentFloor=null,this.object3D.add(this.camera),this.object3D.add(this.backgroundSprite);var o=this.getFloorByHotSpotId(t.ID);this.switchFloorPlan(o),this.setHighlightHotSpotPosition(t),this.setLayer(Layer.FloorPlanManager),this.switchToSmallView()},FloorPlanManager.prototype.update=function(){this.isSmallView||(this.renderer.setClearColor(this.largeViewBackground),this.renderer.clearColor()),this.renderer.setViewport(this.camera.viewPort.left,this.camera.viewPort.top,this.camera.viewPort.width,this.camera.viewPort.height),this.renderer.render(this.scene,this.camera)},FloorPlanManager.prototype.onWindowResize=function(){if(this.isSmallView)this.camera.left=-this.smallViewSize/2,this.camera.right=this.smallViewSize/2,this.camera.top=this.smallViewSize/2,this.camera.bottom=-this.smallViewSize/2;else{var e=Sim.screenWidth/Sim.screenHeight,t=e<1?this.smallViewSize:this.smallViewSize*e,o=e<1?this.smallViewSize/e:this.smallViewSize;this.camera.left=-t/2,this.camera.right=t/2,this.camera.top=o/2,this.camera.bottom=-o/2}var a=Math.min(Sim.screenWidth,Sim.screenHeight);AppParams.isPhone&&(a=Math.min(screen.width,screen.height));var i,n,r,s;if(this.isSmallView){if(i=Math.floor(a*FloorPlanParams.leftBaseSize/FloorPlanParams.refBaseSize),n=Math.floor(a*FloorPlanParams.topBaseSize/FloorPlanParams.refBaseSize),r=s=Math.floor(a*FloorPlanParams.size.baseSize/FloorPlanParams.refBaseSize)+FloorPlanParams.size.extraPixels,AppParams.isPhone){var l=parseInt((r-2)/3);DomElements.switch2DButton.style.width=l+"px",DomElements.switch3DButton.style.width=l+"px",DomElements.switchAutoButton.style.width=r-2-2*l+"px",DomElements.controllerLeft.style.top=r+1+"px"}}else i=0,n=0,r=Sim.screenWidth,s=Sim.screenHeight;this.camera.viewPort={left:i,top:n,width:r,height:s},this.camera.updateProjectionMatrix()},HotSpotManager=function(){Sim.Object.call(this);var e=this,t=new THREE.Object3D;this.setObject3D(t),this.createCylinderHotSpotGroup=function(e,t,o){var a=new THREE.Group;return a.name=e.Name,a.hotSpotData=e,a.position.set(e.Position.x,e.Position.y+4.5,-e.Position.z),a.add(this.createBeamObject3D(t)),a.add(this.createFeetObject3D(o)),AppParams.displayRoomName&&a.add(this.createNameObject3D(e.Name)),this.hotSpotGroups.push(a),a},this.prepareBeamResources=function(){var e=ResourcesLoader.loadTexture("textures/hotspot/light.png");e.minFilter=THREE.NearestFilter;var t=new THREE.CylinderGeometry(StereoHouseParams.beamRadius,StereoHouseParams.beamRadius,StereoHouseParams.beamHeight,20,1,!0);return{material:new THREE.MeshBasicMaterial({map:e,transparent:!0,depthWrite:!1,side:THREE.DoubleSide}),geometry:t}},this.createBeamObject3D=function(e){var t=new THREE.Mesh(e.geometry,e.material);return t.position.set(0,StereoHouseParams.beamHeight/2,0),t},this.prepareFeetResources=function(){var e=ResourcesLoader.loadTexture("textures/hotspot/feet.png");return e.minFilter=THREE.NearestFilter,{material:new THREE.MeshBasicMaterial({map:e,transparent:!0}),geometry:new THREE.PlaneBufferGeometry(12,12,1,1)}},this.createFeetObject3D=function(e){var t=new THREE.Mesh(e.geometry,e.material);return t.rotation.x=THREE.Math.degToRad(270),t},this.createNameObject3D=function(e){var t=TextHelper.createTextSprite(e,{fontsize:250,backgroundColor:{r:0,g:0,b:0,a:.498039},cornerAngle:40});return t.position.set(0,StereoHouseParams.beamHeight/2+StereoHouseParams.hotSpotNameHeight,0),t},this.createLineObject3D=function(){var e=new THREE.LineBasicMaterial({color:32768,linewidth:1}),t=new THREE.Geometry;return t.vertices.push(new THREE.Vector3,new THREE.Vector3(0,StereoHouseParams.beamHeight,0)),new THREE.Line(t,e)},this.createCylinderHotSpotsGroup=function(e,t){var o=new THREE.Group,a=this.prepareBeamResources(),i=this.prepareFeetResources();for(var n in t)o.add(this.createCylinderHotSpotGroup(t[n],a,i));return o.position.y=-e,o},this.registEventListener=function(){for(var t=0;t<this.hotSpotGroups.length;t++)EventListener.get(this.hotSpotGroups[t]).onclick=function(t){e.onHotSpotClicked(t.hotSpotData)}},this.onHotSpotClicked=function(e){}},HotSpotManager.prototype=new Sim.Object,HotSpotManager.prototype.init=function(e,t){this.hotSpotGroups=[],this.object3D.add(this.createCylinderHotSpotsGroup(e,t)),this.registEventListener()},PanoramaManager=function(){function e(e,t){for(var o=0;o<t.length;o++)e.material[o].map=t[o]}function t(e,t){for(var o=0;o<e.material.length;o++)e.material[o].opacity=t}function o(){AppParams.isPhone||n.isRotationTipShowed||($(DomElements.rotationTip).fadeIn(2e3,function(){setTimeout(function(){$(DomElements.rotationTip).fadeOut(1500)},1500)}),n.isRotationTipShowed=!0)}function a(e){for(var t=0;t<e.material.length;t++)null!==e.material[t].map&&(e.material[t].map.dispose(),e.material[t].map=null)}Sim.Object.call(this);var i=new THREE.Object3D;this.setObject3D(i);var n=this;this.setHighlightHotSpotPosition=function(){},this.onCameraRotate=function(){},this.onStartLoadPanoramaImage=function(e){},this.createPanoramaCube=function(){for(var e=[],t=0;t<6;t++)e.push(new THREE.MeshBasicMaterial({side:THREE.BackSide,transparent:!0,alphaTest:.1,depthWrite:!0}));var o=new THREE.Mesh(new THREE.CubeGeometry(1e4,1e4,1e4),e);return o.rotation.reorder("YXZ"),o},this.createLogoPlane=function(){var e=ResourcesLoader.loadTexture("textures/logo.png");this.texture=e,e.minFilter=THREE.NearestFilter;var t=new THREE.PlaneBufferGeometry(PanoramaParams.logoSize,PanoramaParams.logoSize,1,1),o=new THREE.MeshBasicMaterial({map:e,transparent:!0,alphaTest:.5}),a=new THREE.Mesh(t,o);return a.rotation.x=THREE.Math.degToRad(270),a.position.y=-400,a},this.getBlurPanoramaImageUrls=function(e){var t=[];if(e.BlurTileImagesPath&&e.BlurTileImagesPath.length>=6)for(var o in e.TileImagesPath)t.push(AppParams.housePathPrefix+e.BlurTileImagesPath[o]);return t},this.getPanoramaImageUrls=function(e){var t=[];for(var o in e.TileImagesPath)t.push(AppParams.housePathPrefix+e.TileImagesPath[o]);return t},this.loadPanoramaImage=function(t,o,i){if(this.isAnyHotSpotLoaded||(this.isAnyHotSpotLoaded=!0),this.currentHotSpotID!==t.ID&&!n.isLoadingPanoramaImage){this.isLoadingPanoramaImage=!0,this.currentHotSpotID=t.ID,this.onStartLoadPanoramaImage(t.ID);var r;!t.cached&&AppParams.enableBlurLoading?(DomElements.loading.style.visibility="visible",r=this.getBlurPanoramaImageUrls(t),ResourcesLoader.loadTextures(r,null,function(r){n.onPanoramaImageLoad(r,t,o,i),n.loadingClearTextures=ResourcesLoader.loadTextures(n.getPanoramaImageUrls(t),null,function(o){t.cached=!0,n.loadingClearTextures=null,n.cubeFadeAnimation.isPlaying?n.cubeFadeAnimation.progress>=.5&&(n.cubeFadeAnimation.stop(),e(n.cubeFadeAnimation.params.visibleCube,o),n.blurLoadingAnimation.play(n.cubeFadeAnimation.params.invisibleCube,n.cubeFadeAnimation.params.visibleCube,n.cubeFadeAnimation.params.invisibleCube.material[0].opacity)):(e(n.cubeFadeAnimation.params.visibleCube,o),n.blurLoadingAnimation.play(n.cubeFadeAnimation.params.invisibleCube,n.cubeFadeAnimation.params.visibleCube,n.cubeFadeAnimation.params.invisibleCube.material[0].opacity,function(e){a(e.blurPanoramaCube)}))})},null,null)):(t.cached||(DomElements.loading.style.visibility="visible"),r=this.getPanoramaImageUrls(t),ResourcesLoader.loadTextures(r,null,function(e){t.cached=!0,n.onPanoramaImageLoad(e,t,o,i)},null,null))}},this.onPanoramaImageLoad=function(t,o,a,i){DomElements.loading.style.visibility="hidden",this.stopCubeFadeAnimation(),this.blurLoadingAnimation.stop(),n.loadingClearTextures&&(ResourcesLoader.cancelTextures(n.loadingClearTextures),n.loadingClearTextures=null);var r=this.panoramaCube1.visible?this.panoramaCube1:this.panoramaCube2,s=this.panoramaCube1.visible?this.panoramaCube2:this.panoramaCube1;s.name=o.Name;var l=!this.panoramaCube1.visible&&!this.panoramaCube2.visible;this.playCubeFadeAnimation(r,s,o,l,a,i),e(s,t),o.Rotation&&s.rotation.set(THREE.Math.degToRad(o.Rotation.x),THREE.Math.degToRad(180-o.Rotation.y),THREE.Math.degToRad(-o.Rotation.z)),AppParams.isSingleMode||(this.setHighlightHotSpotPosition(o),this.setPositionsToHotSpot(o));for(var c in this.hotSpotGroups){var h=(new THREE.Vector3).subVectors(this.camera.position,this.hotSpotGroups[c].position);this.hotSpotGroups[c].thetaX=Math.atan2(h.z,h.y),this.hotSpotGroups[c].thetaY=Math.atan2(h.z,h.x)}this.hotSpotGroups&&(this.clickedHotSpotGroup=this.hotSpotGroups[o.ID]),this.isLoadingPanoramaImage=!1},this.createCamera=function(){var e=Sim.screenWidth/Sim.screenHeight,t=new THREE.PerspectiveCamera(PanoramaParams.defaultFov,e,.5,1e5);return t.name="PanoramaManager",t.rotation.reorder("YXZ"),t},this.addPanoramaControlsToCamera=function(e){var t=new PanoramaControls(e,this.renderer.domElement);return t.onCameraRotate=function(){n.onCameraRotate()},t},this.createHotSpotGroup=function(e,t){function o(){var e=Date.now()/1e3,t=1.2+.2*Math.sin(5*e),a=.25*t;r.scale.set(a,a,a);var i=.6*t;s.scale.set(i,i,i);var n=t;l.scale.set(n,n,n),requestAnimationFrame(o)}var a=new THREE.Group;a.hotSpotData=e,a.name=e.Name,a.visible=!1;var i=e.Position.y-20;a.position.set(e.Position.x,i,-e.Position.z);var n=new THREE.Sprite(new THREE.SpriteMaterial({opacity:0}));n.name="spriteGroup",a.add(n),n.scale.set(10,10,1);var r=new THREE.Sprite(new THREE.SpriteMaterial({map:t,opacity:1}));n.add(r),r.scale.set(.25,.25,1);var s=new THREE.Sprite(new THREE.SpriteMaterial({map:t,opacity:.6}));n.add(s),s.scale.set(.75,.75,1);var l=new THREE.Sprite(new THREE.SpriteMaterial({map:t,opacity:.2}));if(n.add(l),l.scale.set(1,1,1),o(),AppParams.displayRoomName){var c=TextHelper.createTextSprite(e.Name,{fontsize:80,backgroundColor:{r:0,g:0,b:0,a:.5},cornerAngle:75,borderColor:{r:0,g:0,b:0,a:0}});c.name="hotSpotNameSprite",a.add(c),c.y=7.5,c.position.set(0,c.y,0)}return a},this.registEventListener=function(){for(var e in this.hotSpotGroups)EventListener.get(this.hotSpotGroups[e]).onclick=this.onHotSpotClicked},this.onHotSpotClicked=function(e){n.loadPanoramaImage(e.hotSpotData)},this.hideAllHotSpotGoups=function(){for(var e in this.hotSpotGroups)this.setVisibleIncludeChildren(this.hotSpotGroups[e],!1)},this.showVisibleHotSpotGroups=function(e){for(var t in e.VisibleHotSpotIds){var o=this.hotSpotGroups[e.VisibleHotSpotIds[t]];this.setVisibleIncludeChildren(o,!0)}},this.onZoomInClicked=function(){this.onZoomBtnClicked(!0)},this.onZoomOutClicked=function(){this.onZoomBtnClicked(!1)},this.onZoomBtnClicked=function(e){e&&this.camera.fov===PanoramaParams.minFov||(e||this.camera.fov!==PanoramaParams.maxFov)&&(this.cameraZoomAnimation&&this.cameraZoomAnimation.isPlaying||(this.targetZoomFov=e?this.camera.fov-this.zoomDelta:this.camera.fov+this.zoomDelta,this.targetZoomFov=Math.max(PanoramaParams.minFov,Math.min(PanoramaParams.maxFov,this.targetZoomFov)),this.playCameraZoomAnimation(this.camera.fov)))},this.onSwitchFullScreen=function(){if(AppParams.isFullScreenInNewTab)window.open(window.location.href.replace("&fsnewtab=true",""));else{var e=!DomElements.fullScreenButton.isFullScreen;DomElements.fullScreenButton.isFullScreen=e,DomElements.fullScreenButton.style.backgroundImage="url(textures/"+(e?"exitFullScreen":"fullScreen")+".png)",Util.setFullScreen(e)}},this.playCubeFadeAnimation=function(e,i,r,s,l,c){function h(e){if(e.showBestCameraView&&e.hotSpotData.BestCameraView){var t=-e.hotSpotData.BestCameraView.x,o=-e.hotSpotData.Rotation.y-e.hotSpotData.BestCameraView.y;(t=(t+360)%360)>180&&(t-=360),o=(o+360)%360,n.camera.rotation.x=THREE.Math.degToRad(t),n.camera.rotation.y=THREE.Math.degToRad(o),n.camera.rotation.x=0}}var m={duration:1e3,beginFov:n.camera.fov,fadeInFov:n.camera.fov+1,visibleCube:e,invisibleCube:i,hotSpotData:r,isHotSpotsShowed:!1,onlyFadeOut:s,isStartFadeOut:!1,showBestCameraView:l,isAutoRotate:c};VRManager.isInVRMode&&(m.duration=1),this.cubeFadeAnimation?(this.cubeFadeAnimation.params=m,this.cubeFadeAnimation.duration=m.duration):this.cubeFadeAnimation=new Animation(m,m.duration,function(e,o){function a(e,o){e.invisibleCube.visible=!0,t(e.invisibleCube,o),n.camera.fov=e.fadeInFov+(n.targetZoomFov-e.fadeInFov)*o,o>.1&&!e.isHotSpotsShowed&&(n.hotSpotGroups&&n.showVisibleHotSpotGroups(e.hotSpotData),e.isHotSpotsShowed=!0),e.isStartFadeOut||(e.isStartFadeOut=!0,h(e))}e.onlyFadeOut?a(e,o):o<=.5?(o*=2,t(e.visibleCube,1-o),n.camera.fov=e.beginFov+(e.fadeInFov-e.beginFov)*o):a(e,o=2*(o-.5)),n.camera.updateProjectionMatrix()},function(e){e.visibleCube.visible=!1,t(e.visibleCube,0),e.invisibleCube.visible=!0,t(e.invisibleCube,1),a(e.visibleCube),n.camera.fov=n.targetZoomFov,n.panoramaControls.isAutoPlay=e.isAutoRotate,o()}),this.hideAllHotSpotGoups(),this.cubeFadeAnimation.play()},this.stopCubeFadeAnimation=function(){this.cubeFadeAnimation&&this.cubeFadeAnimation.isPlaying&&this.cubeFadeAnimation.stop()},this.playCameraZoomAnimation=function(e){var t={beginFov:e};this.cameraZoomAnimation?this.cameraZoomAnimation.params=t:this.cameraZoomAnimation=new Animation(t,350,function(e,t){n.camera.fov=e.beginFov+(n.targetZoomFov-e.beginFov)*t,n.camera.updateProjectionMatrix()},function(){n.camera.fov=n.targetZoomFov,n.camera.updateProjectionMatrix(),n.camera.fov===PanoramaParams.minFov?$(DomElements.zoomInButton).addClass("disabled"):$(DomElements.zoomInButton).removeClass("disabled"),n.camera.fov===PanoramaParams.maxFov?$(DomElements.zoomOutButton).addClass("disabled"):$(DomElements.zoomOutButton).removeClass("disabled")}),this.cameraZoomAnimation.play()},this.setPositionsToHotSpot=function(e){var t=(new THREE.Vector3).copy(e.Position);t.z=-t.z,this.camera.position.copy(t),this.panoramaCube1.position.copy(t),this.panoramaCube2.position.copy(t),this.logoPlane.position.set(e.Position.x,-400,-e.Position.z)},this.updateCameraRotation=function(e){this.camera.rotation.setFromVector3(e)},this.setTargetZoomFov=function(e){e&&(this.targetZoomFov=e)},this.updateHotSpotScale=function(){if(this.clickedHotSpotGroup)for(var e in this.clickedHotSpotGroup.hotSpotData.VisibleHotSpotIds){var t=this.hotSpotGroups[this.clickedHotSpotGroup.hotSpotData.VisibleHotSpotIds[e]];if(t){var o=this.camera.position.distanceTo(t.position),a=Math.abs(o*Math.sin(this.camera.rotation.y+t.thetaY)*Math.cos(this.camera.rotation.x/2));t.getObjectByName("spriteGroup").scale.set(.08*a,.08*a,1);var i=t.getObjectByName("hotSpotNameSprite");i&&(i.position.y=i.y*a*.015,i.scale.set(i.material.map.scaleX*a*.015,i.material.map.scaleY*a*.015,1),i.material.rotation=-n.camera.rotation.z)}}}},PanoramaManager.getPanoramaImageUrls=function(e){var t=[];for(var o in e.TileImagesPath)AppParams.enableBlurLoading&&!e.cached?t.push(AppParams.housePathPrefix+e.BlurTileImagesPath[o]):t.push(AppParams.housePathPrefix+e.TileImagesPath[o]);return t},PanoramaManager.getPrepareResourceUrls=function(e){return e.BlurTileImagesPath&&e.BlurTileImagesPath.length>=6||(AppParams.enableBlurLoading=!1),PanoramaManager.getPanoramaImageUrls(e)},PanoramaManager.prototype=new Sim.Object,PanoramaManager.prototype.init=function(e){var t=this;if(this.camera=this.createCamera(),this.scene=this.getScene(),this.renderer=this.getRenderer(),this.houseData=e,this.panoramaCube1=this.createPanoramaCube(),this.panoramaCube2=this.createPanoramaCube(),this.logoPlane=this.createLogoPlane(),this.panoramaControls=this.addPanoramaControlsToCamera(this.camera),this.panoramaControls.autoRotateSpeed=PanoramaParams.autoRotateSpeed,this.currentHotSpotID=null,this.targetZoomFov=PanoramaParams.defaultFov,this.zoomDelta=(PanoramaParams.maxFov-PanoramaParams.minFov)/(PanoramaParams.zoomSteps-1),this.isLoadingPanoramaImage=!1,this.isRotationTipShowed=!1,this.cubeFadeAnimation=null,this.cameraZoomAnimation=null,this.blurLoadingAnimation=new BlurLoadingAnimation,this.loadingClearTextures=null,this.isAnyHotSpotLoaded=!1,this.object3D.add(this.camera),!AppParams.isSingleMode){this.hotSpotGroups={},this.clickedHotSpotGroup=null;var o=ResourcesLoader.loadTexture("textures/hotspot_sprite.png");for(var a in e.HotSpots){var i=this.createHotSpotGroup(e.HotSpots[a],o);this.hotSpotGroups[e.HotSpots[a].ID]=i,this.object3D.add(i)}this.registEventListener()}this.object3D.add(this.logoPlane),this.object3D.add(this.panoramaCube1),this.object3D.add(this.panoramaCube2),this.panoramaCube1.visible=!1,this.panoramaCube2.visible=!1,this.panoramaCube1.scale.set(2,2,2),$(DomElements.zoomInButton).click(function(){t.onZoomInClicked()}),$(DomElements.zoomOutButton).click(function(){t.onZoomOutClicked()}),this.setLayer(Layer.PanoramaManager)},PanoramaManager.prototype.update=function(){this.renderer.setViewport(0,0,Sim.screenWidth,Sim.screenHeight),this.renderer.render(this.scene,this.camera),this.onCameraRotationUpdateForFloorPlan&&this.onCameraRotationUpdateForFloorPlan(this.camera.rotation.y),this.onCameraRotationUpdateForStereoHouse&&this.onCameraRotationUpdateForStereoHouse(this.camera.rotation.y,this.panoramaControls.isAutoPlay),this.updateHotSpotScale()},PanoramaManager.prototype.onWindowResize=function(){this.camera.aspect=Sim.screenWidth/Sim.screenHeight,this.camera.updateProjectionMatrix()},StereoHouseManager=function(){function e(){i.isSmallView||(i.orbitControls.autoRotate=!1,StereoHouseParams.isLargeViewAutoRotate&&t())}function t(){clearTimeout(i.largeViewAutoRotateTimeout),i.largeViewAutoRotateTimeout=setTimeout(function(){!i.isSmallView&&i.object3D.visible&&(i.orbitControls.autoRotate=!0)},AppParams.switchAutoTimeout)}function o(){if(!i.isControlTipShowed){var e=$(DomElements.controlTip);AppParams.isPhone||e.children(":last").hide();var t=(window.innerWidth-e.outerWidth())/2,o=(window.innerHeight-e.outerHeight())/2;e.css("transform","translate("+t+"px, "+o+"px)"),e.fadeIn(1500,function(){setTimeout(function(){e.fadeOut(1500)},2e3)}),i.isControlTipShowed=!0}}Sim.Object.call(this);var a=new THREE.Object3D;this.setObject3D(a);var i=this;this.getDefaultCameraPosition=function(e){var t=THREE.Math.degToRad(120),o=THREE.Math.degToRad(60),a=Math.max(e.x,e.y,e.z);return(new THREE.Vector3).setFromSpherical(new THREE.Spherical(a,o,t))},this.setLargeViewCameraBestPosition=function(){var e=(new THREE.Spherical).setFromVector3(i.camera.position),t=i.camera.aspect<1?i.maxHouseSize/i.camera.aspect:i.maxHouseSize;e.radius=t+100,i.camera.position.setFromSpherical(e),i.orbitControls.maxDistance=e.radius*StereoHouseParams.orbitControlsMaxDistance},this.addOrbitControlsToCamera=function(e,t){var o=new THREE.OrbitControls(e,this.renderer.domElement);o.maxPolarAngle=THREE.Math.degToRad(90),o.minPolarAngle=THREE.Math.degToRad(10),o.autoRotate=StereoHouseParams.isLargeViewAutoRotate,o.autoRotateSpeed=1,o.zoomSpeed=1,o.enableDamping=!0,o.dampingFactor=.8,o.enablePan=!1;var a=Math.max(t.x,t.y,t.z),i=(t.x+t.z)/2;return o.minDistance=i*StereoHouseParams.orbitControlsMinDistance,o.maxDistance=a*StereoHouseParams.orbitControlsMaxDistance,o},this.createCamera=function(e){var t=new THREE.PerspectiveCamera(StereoHouseParams.largeFov,1,.5,1e5);return t.name="HouseManager",t.rotation.reorder("YXZ"),t.position.copy(this.getDefaultCameraPosition(e)),t},this.createBackgroundCube=function(e){for(var t=[],o=0;o<6;o++)t.push(new THREE.MeshBasicMaterial({side:THREE.BackSide,transparent:!0,color:FloorPlanParams.bgColor,opacity:FloorPlanParams.bgOpacity}));var a=2*Math.max(e.x,e.y,e.z),i=new THREE.Mesh(new THREE.CubeGeometry(a,a,a),t);return this.backgroundCube=i,i},this.switchToSmallViewWithAnimation=function(e){var t=i.camera.position.clone(),o=i.camera.rotation.clone(),a=(new THREE.Vector3).copy(e.Position);a.z=-a.z;var n=o.clone();n.x=0;i.cameraFlyAnimation.play(i.camera,t,o,a,n,function(){i.switchView(!0)},function(){i.hotSpotManager.setVisible(!1)})},this.switchToSmallView=function(){i.switchView(!0),i.onSwitchToSmallView()},this.switchToLargeView=function(){i.switchView(!1),o(),i.setLargeViewCameraBestPosition(),i.onSwitchToLargeView()},this.switchView=function(e){this.isSmallView=e,this.hotSpotManager.setVisible(!e),this.orbitControls.enabled=!e,this.orbitControls.autoRotate=!e&&StereoHouseParams.isLargeViewAutoRotate,this.backgroundCube.visible=e,this.camera.fov=e?StereoHouseParams.smallFov:StereoHouseParams.largeFov,this.onWindowResize(),DomElements.enterHotSpotTip.style.visibility=e?"hidden":"visible",DomElements.thumbnailController.style.visibility=e||AppParams.alwaysDisplayThumbnail?"visible":"hidden",DomElements.controlDiv.style.visibility=e?"visible":"hidden",DomElements.enterPanoramaViewBtn.style.visibility=e?"hidden":"visible",this.enableRoomEvents(!e)},this.onPanoramaCameraRotationUpdate=function(e,t){if(i.isSmallView){var o=i.isSmallViewAutoRotate&&!t?i.camera.lastTheta-.002*StereoHouseParams.smallViewAutoRotateSpeed:e,a=(new THREE.Vector3).setFromSpherical(new THREE.Spherical(i.smallViewControlRadius,1,o));i.camera.position.copy(a),i.camera.lookAt(new THREE.Vector3(0,0,0)),i.camera.lastTheta=o}},this.enableSmallViewAutoRotate=function(e){this.isSmallViewAutoRotate=e},this.getHotSpotById=function(e){var t=this.houseData.HotSpots;for(var o in t)if(t[o].ID===e)return t[o]},this.onRoomClicked=function(e){if(e.HotSpotIds&&e.HotSpotIds.length>0){var t=i.getHotSpotById(e.HotSpotIds[0]);t&&i.onHotSpotClicked(t)}},this.registEventListener=function(){EventListener.get(this.backgroundCube).onclick=this.switchToLargeView,document.attachEvent?(i.renderer.domElement.attachEvent("touchend",e,!1),i.renderer.domElement.attachEvent("mouseup",e,!1)):(i.renderer.domElement.addEventListener("touchend",e,!1),i.renderer.domElement.addEventListener("mouseup",e,!1))},this.enableRoomEvents=function(e){for(var t in this.roomObj3Ds)this.roomObj3Ds[t].enableRoomFaceEvents(e)},this.onSwitchToLargeView=function(){},this.onSwitchToSmallView=function(){},this.onHotSpotClicked=function(){}},StereoHouseManager.getPrepareResourceUrls=function(e){var t=[];for(var o in e.Floors){var a=e.Floors[o];for(var i in a.Rooms){var n=a.Rooms[i];for(var r in n.RoomFaces){var s=n.RoomFaces[r],l=AppParams.housePathPrefix+s.ImagePath;t.push(l)}}}return t},StereoHouseManager.prototype=new Sim.Object,StereoHouseManager.prototype.init=function(e){this.object3D.name=e.Name,this.scene=this.getScene(),this.renderer=this.getRenderer(),this.largeViewBackground=new THREE.Color(AppParams.largeViewBgColor),this.camera=this.createCamera(e.HouseSize),this.orbitControls=this.addOrbitControlsToCamera(this.camera,e.HouseSize),this.isSmallView=!1,this.backgroundCube=null,this.isSmallViewAutoRotate=!1,this.largeViewAutoRotateTimeout=null,this.isControlTipShowed=!1,this.maxHouseSize=Math.max(e.HouseSize.x,e.HouseSize.y,e.HouseSize.z),this.smallViewControlRadius=2*this.maxHouseSize,this.houseData=e,this.roomObj3Ds=[],this.cameraFlyAnimation=new CameraFlyAnimation,this.object3D.add(this.camera);for(var t in e.Floors){var o=e.Floors[t];for(var a in o.Rooms){var i=new StereoRoom;this.addChild(i),i.init(o.Rooms[a]),i.onRoomClicked=this.onRoomClicked,this.roomObj3Ds.push(i)}}this.hotSpotManager=new HotSpotManager,this.addChild(this.hotSpotManager),this.hotSpotManager.init(e.CameraHeight,e.HotSpots),this.object3D.add(this.createBackgroundCube(e.HouseSize)),this.setLayer(Layer.StereoHouse),this.registEventListener()},StereoHouseManager.prototype.update=function(){this.isSmallView||(this.renderer.setClearColor(this.largeViewBackground),this.renderer.clearColor()),this.renderer.setViewport(this.camera.viewPort.left,this.camera.viewPort.top,this.camera.viewPort.width,this.camera.viewPort.height),this.renderer.render(this.scene,this.camera),this.orbitControls.update()},StereoHouseManager.prototype.onWindowResize=function(){var e=Math.min(Sim.screenWidth,Sim.screenHeight);AppParams.isPhone&&(e=Math.min(screen.width,screen.height));var t,o,a,i;this.isSmallView?(t=Math.floor(e*FloorPlanParams.leftBaseSize/FloorPlanParams.refBaseSize),o=Math.floor(e*FloorPlanParams.topBaseSize/FloorPlanParams.refBaseSize),a=i=Math.floor(e*FloorPlanParams.size.baseSize/FloorPlanParams.refBaseSize)+FloorPlanParams.size.extraPixels,this.camera.aspect=1):(t=0,o=0,a=Sim.screenWidth,i=Sim.screenHeight,this.camera.aspect=a/i),this.camera.viewPort={left:t,top:o,width:a,height:i},this.camera.updateProjectionMatrix()},StereoRoom=function(){function e(e){var t=new THREE.PlaneBufferGeometry(e.Width,e.Height,1,1),a=new THREE.MeshBasicMaterial({map:null,side:THREE.BackSide,alphaTest:.1});a.transparent=!0,a.depthWrite=!0;var i=new THREE.Mesh(t,a);i.rotation.reorder("YXZ"),i.rotation.set(THREE.Math.degToRad(e.Rotation.x),THREE.Math.degToRad(e.Rotation.y),THREE.Math.degToRad(e.Rotation.z)),i.position.set(e.Position.x,e.Position.y,-e.Position.z),i.visible=!1;var n=AppParams.housePathPrefix+e.ImagePath;return ResourcesLoader.loadTextureInQueue(n,function(e){e.minFilter=THREE.LinearFilter,a.map=e,a.needsUpdate=!0,i.visible=!0}),o.roomFaces.push(i),i}Sim.Object.call(this);var t=new THREE.Object3D;this.setObject3D(t);var o=this;this.createRoomFaces=function(t){for(var o in t.RoomFaces)this.object3D.add(e(t.RoomFaces[o]))},this.onRoomFaceClicked=function(){o.onRoomClicked(o.roomData)},this.registEventListener=function(){for(var e in this.roomFaces)EventListener.get(this.roomFaces[e]).onclick=this.onRoomFaceClicked},this.enableRoomFaceEvents=function(e){for(var t in this.roomFaces)EventListener.get(this.roomFaces[t]).enabled=e},this.onRoomClicked=function(){}},StereoRoom.prototype=new Sim.Object,StereoRoom.prototype.init=function(e){this.object3D.name=e.Name,this.object3D.position.set(e.Position.x,e.Position.y,-e.Position.z),this.object3D.rotation.set(0,THREE.Math.degToRad(-e.Rotation),0),this.roomFaces=[],this.roomData=e,this.createRoomFaces(e),this.registEventListener()},ThumbnailManager=function(e,t){var o,a,i,n={},r=0,s=function(e){var t=[];for(var o in e.HotSpots){var a=e.HotSpots[o],i=AppParams.housePathPrefix+(a.ThumbnailPath||"ThumbnailImages/"+a.ImagePath);i=i.replace("\\","/"),t.push({name:a.Name,imagePath:i})}return t}(e);i=s.length;var l=parseInt((Sim.screenWidth-28)/110),c=[],h=this,m=!1;AppParams.isPhone&&($(DomElements.thumbnailControlButton).addClass("phone expand").hover(function(){$(this).toggleClass("expand collap")}),$(DomElements.thumbnailList).addClass("phone")),$(DomElements.thumbnailControlButton).click(function(){"none"==DomElements.thumbnailList.style.display?(AppParams.isPhone&&(this.style.backgroundImage="url(textures/thumbnailPhone.png)"),$(DomElements.thumbnailList).slideDown("slow")):(AppParams.isPhone&&(this.style.backgroundImage="url(textures/thumbnailPhonePress.png)"),$(DomElements.thumbnailList).slideUp("slow"))}),this.loadThumbnail=function(){DomElements.thumbnailController.style.visibility="visible",m=!0,l<i&&(l=parseInt((Sim.screenWidth-50)/110)),AppParams.isPhone&&(l=parseInt(Sim.screenWidth/73));for(var r in s){var h=AppParams.displayRoomName?"inline-block":"none",u=document.createElement("div");u.className=AppParams.isPhone?"thumbnail_group phone":"thumbnail_group",u.innerHTML='<div class="thumbnail-normal thumbnail-unselected '+(AppParams.isPhone?"phone":"")+'"><div style="background: url(\''+s[r].imagePath+'\') no-repeat center;background-size: cover;background-position-x: 0;"></div><div class="thumbnail-caption text-overlay-bg-trans"><span class="thumbnail_name" style="display: '+h+'">'+s[r].name+"</span></div></div>",r>=l&&!AppParams.isPhone&&(u.style.display="none"),u.index=parseInt(r),u.onclick=function(){a!=this.index&&t(e.HotSpots[this.index])},n[e.HotSpots[r].ID]=u,$(DomElements.thumbnails).append(u),c.push(u)}$(c[0].children.item(0)).removeClass("thumbnail-unselected"),o=c[0],a=0,AppParams.isPhone||(l<i&&($(DomElements.naviLeft).show(),$(DomElements.naviRight).show()),$(DomElements.naviLeft).addClass("disabled").click(function(){a>0&&t(e.HotSpots[a-1])}),$(DomElements.naviRight).click(function(){a+1<i&&t(e.HotSpots[a+1])}))},this.moveThumbnails=function(){var e=parseInt((Sim.screenWidth-28)/110);AppParams.isPhone?e=parseInt(Sim.screenWidth/73):e<i?(e=parseInt((Sim.screenWidth-50)/110),$(DomElements.naviLeft).show(),$(DomElements.naviRight).show()):($(DomElements.naviLeft).hide(),$(DomElements.naviRight).hide());var t=parseInt(e/2),o=Math.max(a-t,0),n=Math.min(o+e-1,i-1),s=Math.min(r+l-1,i-1);if(AppParams.isPhone)DomElements.thumbnailList.scrollLeft=73*o;else{for(;o<r;)c[--r].style.display="inline-block";for(;o>r;)c[r++].style.display="none";for(;n<s;)c[++n].style.display="none";for(;n>s;)c[n--].style.display="inline-block"}l=e,r=o},this.setSelectedThumbnailVisible=function(){var e=Math.min(r+l-1,i-1);if(a<r||a>e){var t=parseInt(l/2),o=Math.max(a-t,0),n=Math.min(o+l-1,i-1);if(n==i-1&&(o=i-l),AppParams.isPhone)DomElements.thumbnailList.scrollLeft=73*o;else{for(s=r;s<=e;++s)c[s].style.display="none";for(var s=o;s<=n;++s)c[s].style.display="inline-block"}r=o}},this.selectThumbnail=function(e){m||h.loadThumbnail(),n[e]!=o&&(o&&$(o.children.item(0)).addClass("thumbnail-unselected"),$(n[e].children.item(0)).removeClass("thumbnail-unselected"),o=n[e],a=o.index,AppParams.isPhone||(0==a?$(DomElements.naviLeft).addClass("disabled"):$(DomElements.naviLeft).removeClass("disabled"),a+1==i?$(DomElements.naviRight).addClass("disabled"):$(DomElements.naviRight).removeClass("disabled")),h.setSelectedThumbnailVisible())},this.onWindowResize=function(){h.moveThumbnails()}},VRManager=function(){Sim.Object.call(this);var e=new THREE.Object3D;this.setObject3D(e),this.createCrosshairRing=function(){var e=new THREE.Mesh(new THREE.RingGeometry(.02,.04,32),new THREE.MeshBasicMaterial({color:16777215,opacity:.5,transparent:!0}));return e.visible=!1,e.position.z=-2,e},this.showVRStartTip=function(e){var t=$(DomElements.vrStartTip);e?(DomElements.vrStartTip.style.visibility="visible",t.stop(),clearTimeout(DomElements.vrStartTip.timeout),t.fadeIn(500,function(){DomElements.vrStartTip.timeout=setTimeout(function(){t.fadeOut(1500)},2e3)})):(t.stop(),t.hide())},this.enable=function(e){this.object3D.visible=e,this.vrControls.resetSensor(),this.vrControls.enabled=e,this.vrControls.manualRotation=this.camera.rotation.clone(),e||this.enableVRMode(!1),this.isLandscape=Util.isLandscape(),this.showVRStartTip(e&&!this.isLandscape)},this.enableVRMode=function(e){EventListener.vrEnabled=e,this.crossHairRing.visible=e,this.isInVRMode=e,this.showVRStartTip(!e),e?(this.previousFov=this.camera.fov,this.camera.fov=VRParams.fov):this.previousFov&&(this.camera.fov=this.previousFov),this.camera.updateProjectionMatrix(),this.onVRModeEnabled(e),VRManager.isInVRMode=e},this.onVRModeEnabled=function(e){}},VRManager.isInVRMode=!1,VRManager.prototype=new Sim.Object,VRManager.prototype.init=function(e){this.scene=this.getScene(),this.renderer=this.getRenderer(),this.camera=e,this.vrControls=new THREE.VRControls(this.camera,this.renderer.domElement),this.vrEffect=new THREE.StereoEffect(this.renderer),this.vrEffect.setSize(Sim.screenWidth,Sim.screenHeight),this.isLandscape=Util.isLandscape(),this.isInVRMode=!1,this.crossHairRing=this.createCrosshairRing(),this.previousFov=null,this.camera.add(this.crossHairRing),this.setLayer(Layer.PanoramaManager)},VRManager.prototype.update=function(){this.isLandscape?(this.vrEffect.render(this.scene,this.camera),this.isInVRMode||this.enableVRMode(!0)):this.isInVRMode&&this.enableVRMode(!1)},VRManager.prototype.onWindowResize=function(){this.isLandscape=Util.isLandscape()},PhoneVR=function(){this.deviceAlpha=null,this.deviceGamma=null,this.deviceBeta=null,window.addEventListener("deviceorientation",function(e){this.deviceAlpha=e.alpha,this.deviceGamma=e.gamma,this.deviceBeta=e.beta}.bind(this))},PhoneVR.prototype.orientationIsAvailable=function(){return null!==this.deviceAlpha},PhoneVR.prototype.rotationQuat=function(){if(!this.orientationIsAvailable())return null;var e=Math.PI/180,t=this.deviceAlpha*e/2,o=this.deviceBeta*e/2,a=this.deviceGamma*e/2,i=Math.cos(o),n=Math.cos(a),r=Math.cos(t),s=Math.sin(o),l=Math.sin(a),c=Math.sin(t),h=i*n*r-s*l*c,o=s*n*r-i*l*c,a=i*l*r+s*n*c,t=i*n*c+s*l*r,m=new THREE.Quaternion(o,a,t,h),u=this.getScreenOrientation()*e/2,d=new THREE.Quaternion(0,0,-Math.sin(u),Math.cos(u)),p=new THREE.Quaternion;p.multiplyQuaternions(m,d);var g=Math.sqrt(.5);return p.multiplyQuaternions(new THREE.Quaternion(-g,0,0,g),p),p},PhoneVR.prototype.getScreenOrientation=function(){switch(window.screen.orientation||window.screen.mozOrientation){case"landscape-primary":return 90;case"landscape-secondary":return-90;case"portrait-secondary":return 180;case"portrait-primary":return 0}if(void 0!==window.orientation)return window.orientation},THREE.VRControls=function(e,t){function o(){if(g.enabled){var e=g.camera,t=g.getVRState(),o=g.manualRotation.clone();if(e){if(!t)return void e.rotation.copy(o);var a=new THREE.Euler,i=t.hmd.rotation;if(0!==i[0]||0!==i[1]||0!==i[2]||0!==i[3]){var n=new THREE.Quaternion(i[0],i[1],i[2],i[3]);(a=(new THREE.Euler).setFromQuaternion(n).reorder("YXZ")).y-=Math.PI/2,a.x+=o.x,a.y+=o.y}else a=o;e.rotation.copy(a)}}}function a(){requestAnimationFrame(a),o()}function i(e,t){h=!0,m=e,d=g.manualRotation.y}function n(e,t){h&&g.enabled&&(u=(e-m)*g.speed*.002+d,g.manualRotation=new THREE.Euler(0,u,0).reorder("YXZ"))}function r(){h=!1}function s(e){e.preventDefault(),e.stopPropagation(),i(e.touches[0].pageX*g.speed*p,e.touches[0].pageY*g.speed*p)}function l(e){e.preventDefault(),e.stopPropagation(),n(e.touches[0].pageX*g.speed*p,e.touches[0].pageY*g.speed*p)}function c(e){e.preventDefault(),e.stopPropagation(),r()}var h=!1,m=0,u=0,d=0;this.phoneVR=new PhoneVR,this.camera=e,this.manualRotation=new THREE.Euler,this.enabled=!1,this.speed=1;var p=3,g=this;!function(e){null!==e&&void 0!==e||(e=document),e.addEventListener("touchstart",s,!1),e.addEventListener("touchend",c,!1),e.addEventListener("touchmove",l,!1)}(t),a(),this.resetSensor=function(){var e=this._vrInput;if(!e)return null;e.resetSensor()},this.getVRState=function(){var e,t=this._vrInput;if(t)e=t.getState().orientation;else{if(!this.phoneVR.rotationQuat())return null;e=this.phoneVR.rotationQuat()}return null===e?null:{hmd:{rotation:[e.x,e.y,e.z,e.w]}}}},THREE.StereoEffect=function(e){var t=new THREE.StereoCamera;t.aspect=.5,this.setEyeSeparation=function(e){t.eyeSep=e},this.setSize=function(t,o){e.setSize(t,o)},this.render=function(o,a){o.updateMatrixWorld(),null===a.parent&&a.updateMatrixWorld(),t.update(a);var i=e.getSize();e.clear(),e.setScissorTest(!0),e.setScissor(0,0,i.width/2,i.height),e.setViewport(0,0,i.width/2,i.height),e.render(o,t.cameraL),e.setScissor(i.width/2,0,i.width/2,i.height),e.setViewport(i.width/2,0,i.width/2,i.height),e.render(o,t.cameraR),e.setScissorTest(!1)}},CameraFlyAnimation=function(){var e={duration:600,positionPower:1/3,rotationPower:3,closeToHotSpotThreshold:75};Animation.call(this,e,e.duration)},CameraFlyAnimation.prototype=new Animation,CameraFlyAnimation.prototype.play=function(e,t,o,a,i,n,r){var s={camera:e,startPosition:t,startRotation:o,endPosition:a,endRotation:i,onFinished:n,onCloseToTarget:r};this.params=Object.assign(this.params,s),Animation.prototype.play.call(this)},CameraFlyAnimation.prototype.update=function(e,t){var o=e.startPosition.clone(),a=e.startRotation.toVector3();o=o.lerp(e.endPosition,Math.pow(t,e.positionPower)),a=a.lerp(e.endRotation,Math.pow(t,e.rotationPower)),e.camera.position.copy(o),e.camera.rotation.setFromVector3(a),o.distanceTo(e.endPosition)<e.closeToHotSpotThreshold&&e.onCloseToTarget&&e.onCloseToTarget()},CameraFlyAnimation.prototype.onFinished=function(e){e.onFinished&&e.onFinished()},BlurLoadingAnimation=function(){var e={duration:350};this.setCubeOpacity=function(e,t){for(var o=0;o<e.material.length;o++)e.material[o].opacity=t},this.setCubeTransparent=function(e,t){for(var o=0;o<e.material.length;o++)e.material[o].transparent=t,e.material[o].depthWrite=t},Animation.call(this,e,e.duration)},BlurLoadingAnimation.prototype=new Animation,BlurLoadingAnimation.prototype.play=function(e,t,o,a){var i={blurPanoramaCube:e,clearPanoramaCube:t,startOpacity:o,onFinished:a};this.params=Object.assign(this.params,i),this.params.duration=o*this.params.duration,Animation.prototype.play.call(this)},BlurLoadingAnimation.prototype.update=function(e,t){var o=e.startOpacity*(1-t);this.setCubeOpacity(e.blurPanoramaCube,o),e.clearPanoramaCube.visible||(e.clearPanoramaCube.visible=!0,e.clearPanoramaCube.rotation.copy(e.blurPanoramaCube.rotation),e.clearPanoramaCube.scale.set(2,2,2),e.blurPanoramaCube.scale.set(1,1,1),this.setCubeTransparent(e.blurPanoramaCube,!0),this.setCubeTransparent(e.clearPanoramaCube,!1),this.setCubeOpacity(e.clearPanoramaCube,1))},BlurLoadingAnimation.prototype.onFinished=function(e){e.blurPanoramaCube.visible=!1,this.setCubeTransparent(e.blurPanoramaCube,!0),this.setCubeTransparent(e.clearPanoramaCube,!0),e.onFinished&&e.onFinished(e)},domain="house/",domain=Util.getUrlParameter("domain")||domain,housePathPrefix=Util.getUrlParameter("hid")?domain+Util.getUrlParameter("hid")+"/":domain,isFullScreenInNewTab="true"===Util.getUrlParameter("fsnewtab"),AppParams={housePathPrefix:housePathPrefix,isSingleMode:!!Util.getUrlParameter("mode"),largeViewBgColor:6710886,switchAutoTimeout:6e3,isPhone:Util.checkIsPhone(),displayRoomName:!0,isPlayCameraFlyAnimation:!1,isDisplayPanoramaFirst:!0,enableBlurLoading:!1,isFullScreenInNewTab:isFullScreenInNewTab,alwaysDisplayThumbnail:!1},VRParams={gazeTime:1500,fov:93},StereoHouseParams={largeFov:60,smallFov:35,orbitControlsMaxDistance:1.4,orbitControlsMinDistance:.7,smallViewAutoRotateSpeed:.7,isLargeViewAutoRotate:!0,beamHeight:70,beamRadius:12,hotSpotNameHeight:40},FloorPlanParams={size:{baseSize:AppParams.isPhone?138:115,extraPixels:AppParams.isPhone?2:4},leftBaseSize:AppParams.isPhone?0:20,topBaseSize:AppParams.isPhone?0:48,refBaseSize:AppParams.isPhone?375:450,bgColor:0,bgOpacity:.7,smallViewMargin:1.05,hotSpotSize:40,hotSpotNameMarginTop:-48},PanoramaParams={maxFov:100,minFov:50,zoomSteps:3,defaultFov:100,logoSize:250,isAutoRotateWhenStart:!0,autoRotateSpeed:.3},Layer={PanoramaManager:0,FloorPlanManager:1,StereoHouse:2},HouseModel=function(){this.Floors=[],this.HotSpots=[],this.ID="",this.Name="",this.CameraHeight=0,this.HouseSize=void 0,this.CoverImagePath="",this.DefaultHotSpotId="",this.ClientVersion=""},Floor=function(){this.ID="",this.Name="",this.FloorSize=void 0,this.FloorPlanPath="",this.Rooms=[],this.FloorPlanCenterPoint=void 0,this.IsMatchCustomFloorPlan=!1},Room=function(){this.ID="",this.Name="",this.Position=void 0,this.Rotation=0,this.RoomFaces=[],this.HotSpotIds=[]},RoomFace=function(){this.Name="",this.Position=void 0,this.Rotation=void 0,this.Width=0,this.Height=0,this.ImagePath=""},HotSpot=function(){this.ID="",this.Name="",this.TileImagesPath=[],this.BlurTileImagesPath=[],this.ThumbnailPath="",this.Position=void 0,this.Rotation=void 0,this.BestCameraView=void 0,this.VisibleHotSpotIds=[]},VRHouseApp=function(){Sim.App.call(this);var e=this;this.onSwitch2DBtnClicked=function(){DomElements.switch2DButton.isPressed||(e.stopHouseSmallViewAutoRotateTimer(),e.floorPlanManager.object3D.visible=!0,e.stereoHouseManager.object3D.visible=!1,e.stereoHouseManager.enableSmallViewAutoRotate(!1),this.onSwitchBtnClicked(DomElements.switch2DButton,this.floorPlanSwitchBtnGroup))},this.onSwitch3DBtnClicked=function(){DomElements.switch3DButton.isPressed||(e.stopHouseSmallViewAutoRotateTimer(),e.floorPlanManager.object3D.visible=!1,e.stereoHouseManager.object3D.visible=!0,e.stereoHouseManager.enableSmallViewAutoRotate(!1),this.onSwitchBtnClicked(DomElements.switch3DButton,this.floorPlanSwitchBtnGroup))},this.onLargeViewSwitch2DBtnClicked=function(){DomElements.largeViewSwitch2DButton.isPressed||(this.onSwitchBtnClicked(DomElements.largeViewSwitch2DButton,this.largeViewSwitchBtnGroup),this.onSwitch2DBtnClicked(),this.floorPlanManager.isSmallView&&this.floorPlanManager.switchToLargeView(),e.stereoHouseManager.orbitControls.enabled=!1,DomElements.enterHotSpotTip.style.visibility="hidden")},this.onLargeViewSwitch3DBtnClicked=function(){DomElements.largeViewSwitch3DButton.isPressed||(this.onSwitchBtnClicked(DomElements.largeViewSwitch3DButton,this.largeViewSwitchBtnGroup),this.onSwitch3DBtnClicked(),this.stereoHouseManager.isSmallView&&this.stereoHouseManager.switchToLargeView(),e.stereoHouseManager.orbitControls.enabled=!0,DomElements.enterHotSpotTip.style.visibility="visible")},this.onSwitchAutoBtnClicked=function(){DomElements.switchAutoButton.isPressed||(this.startHouseSmallViewAutoRotateTimer(),this.onSwitchBtnClicked(DomElements.switchAutoButton,this.floorPlanSwitchBtnGroup))},this.onSwitchBtnClicked=function(e,t){for(var o in t){var a=t[o];$(a).removeClass("switchButtonPressed").removeClass("switchButton"),a.isPressed=a===e;var i=a.isPressed?"switchButtonPressed":"switchButton";$(a).addClass(i)}},this.onVRBtnClicked=function(){var e=!DomElements.switchVRButton.enabled;if(DomElements.switchVRButton.enabled=e,this.vrManager.enable(e),this.panoramaManager.panoramaControls.enabled=!e,e)$(DomElements.controllerLeft).hide(),$(DomElements.thumbnailController).hide(),DomElements.switchVRButton.style.backgroundImage="url(textures/vrPress.png)",this.stopHouseSmallViewAutoRotateTimer(),this.floorPlanManager.object3D.visible=!1,this.stereoHouseManager.object3D.visible=!1;else{$(DomElements.controllerLeft).show(),$(DomElements.thumbnailController).show(),DomElements.switchVRButton.style.backgroundImage="url(textures/vr.png)";for(var t in this.floorPlanSwitchBtnGroup){var o=this.floorPlanSwitchBtnGroup[t];if(o.isPressed){o.isPressed=!1,o===DomElements.switchAutoButton?(this.stereoHouseManager.object3D.visible=!0,this.onSwitchAutoBtnClicked()):o===DomElements.switch2DButton?this.onSwitch2DBtnClicked():o===DomElements.switch3DButton&&this.onSwitch3DBtnClicked();break}}this.panoramaManager.updateCameraRotation(new THREE.Vector3(0,this.panoramaManager.camera.rotation.y,0))}},this.startHouseSmallViewAutoRotateTimer=function(){this.stopHouseSmallViewAutoRotateTimer(),DomElements.switchAutoButton.timeout=setTimeout(function(){e.panoramaManager.object3D.visible&&(e.floorPlanManager.object3D.visible=!1,e.stereoHouseManager.object3D.visible=!0,e.stereoHouseManager.enableSmallViewAutoRotate(!0))},AppParams.switchAutoTimeout)},this.stopHouseSmallViewAutoRotateTimer=function(){clearTimeout(DomElements.switchAutoButton.timeout)},this.onPanoramaCameraRotate=function(){e.vrManager&&e.vrManager.object3D.visible||DomElements.switchAutoButton.isPressed&&e.panoramaManager.object3D.visible&&(e.floorPlanManager.object3D.visible||(e.floorPlanManager.object3D.visible=!0,e.stereoHouseManager.object3D.visible=!1),e.stereoHouseManager.enableSmallViewAutoRotate(!1),e.startHouseSmallViewAutoRotateTimer())},this.onThumbnailClicked=function(t){e.switchToPanoramaView(),e.panoramaManager.loadPanoramaImage(t,!0)},this.onHotSpotClicked=function(t){e.panoramaManager.loadPanoramaImage(t),e.switchToPanoramaView()},this.switchToPanoramaView=function(){e.stereoHouseManager.isSmallView||(AppParams.isPlayCameraFlyAnimation?e.stereoHouseManager.switchToSmallViewWithAnimation(hotSpotData):e.stereoHouseManager.switchToSmallView()),e.floorPlanManager.isSmallView||e.floorPlanManager.switchToSmallView()},this.getDefaultHotSpot=function(e){var t=e.HotSpots[0];if(e.DefaultHotSpotId&&""!==e.DefaultHotSpotId)for(var o in e.HotSpots)e.HotSpots[o].ID===e.DefaultHotSpotId&&(t=e.HotSpots[o]);return t},this.onEnterPanoramaViewBtnClicked=function(){e.panoramaManager.isAnyHotSpotLoaded?e.switchToPanoramaView():e.onHotSpotClicked(e.getDefaultHotSpot(e.houseData))},this.bindControlEvents=function(){e.onSwitchAutoBtnClicked(),e.panoramaManager.setHighlightHotSpotPosition=e.floorPlanManager.setHighlightHotSpotPosition,e.panoramaManager.onCameraRotate=e.onPanoramaCameraRotate,e.panoramaManager.onCameraRotationUpdateForFloorPlan=e.floorPlanManager.onPanoramaCameraRotationUpdate,e.panoramaManager.onCameraRotationUpdateForStereoHouse=e.stereoHouseManager.onPanoramaCameraRotationUpdate,e.floorPlanManager.onHotSpotClick=e.onHotSpotClicked,e.stereoHouseManager.onHotSpotClicked=e.onHotSpotClicked,e.stereoHouseManager.hotSpotManager.onHotSpotClicked=e.onHotSpotClicked,e.stereoHouseManager.onSwitchToLargeView=function(){e.panoramaManager.object3D.visible=!1,e.onSwitchBtnClicked(DomElements.largeViewSwitch3DButton,e.largeViewSwitchBtnGroup),$(DomElements.controllerLeft).hide(),$(DomElements.zoomInButton).hide(),$(DomElements.zoomOutButton).hide(),DomElements.largeViewSwitchController.style.visibility="visible"},e.stereoHouseManager.onSwitchToSmallView=function(){e.panoramaManager.object3D.visible=!0,e.panoramaManager.updateCameraRotation(new THREE.Vector3(0,e.stereoHouseManager.camera.rotation.y,0)),$(DomElements.controllerLeft).show(),$(DomElements.zoomInButton).show(),$(DomElements.zoomOutButton).show(),DomElements.largeViewSwitchController.style.visibility="hidden"},e.floorPlanManager.onSwitchToLargeView=function(){e.panoramaManager.object3D.visible=!1,e.onSwitchBtnClicked(DomElements.largeViewSwitch2DButton,e.largeViewSwitchBtnGroup),$(DomElements.controllerLeft).hide(),$(DomElements.zoomInButton).hide(),$(DomElements.zoomOutButton).hide(),DomElements.largeViewSwitchController.style.visibility="visible"},e.floorPlanManager.onSwitchToSmallView=function(){e.panoramaManager.object3D.visible=!0,e.panoramaManager.updateCameraRotation(new THREE.Vector3(0,e.panoramaManager.camera.rotation.y,0)),$(DomElements.controllerLeft).show(),$(DomElements.zoomInButton).show(),$(DomElements.zoomOutButton).show(),DomElements.largeViewSwitchController.style.visibility="hidden"},$(DomElements.switchAutoButton).click(function(){e.onSwitchAutoBtnClicked()}),$(DomElements.switch2DButton).click(function(){e.onSwitch2DBtnClicked()}),$(DomElements.switch3DButton).click(function(){e.onSwitch3DBtnClicked()}),$(DomElements.largeViewSwitch2DButton).click(function(){e.onLargeViewSwitch2DBtnClicked()}),$(DomElements.largeViewSwitch3DButton).click(function(){e.onLargeViewSwitch3DBtnClicked()}),$(DomElements.enterPanoramaViewBtn).click(this.onEnterPanoramaViewBtnClicked),$(DomElements.switchVRButton).click(function(){e.onVRBtnClicked()})},this.loadPanoramaManager=function(t){this.panoramaManager=new PanoramaManager,this.addObject(this.panoramaManager),this.panoramaManager.init(t),$(DomElements.fullScreenButton).click(function(){e.panoramaManager.onSwitchFullScreen()})},this.loadThumbnailManager=function(e){this.thumbnailManager=new ThumbnailManager(e,this.onThumbnailClicked),this.panoramaManager.onStartLoadPanoramaImage=this.thumbnailManager.selectThumbnail},this.loadStereoHouseManager=function(e){this.stereoHouseManager=new StereoHouseManager,this.addObject(this.stereoHouseManager),this.stereoHouseManager.init(e)},this.loadFloorPlanManager=function(e){var t=this.getDefaultHotSpot(e);this.floorPlanManager=new FloorPlanManager,this.addObject(this.floorPlanManager),this.floorPlanManager.init(e,t)},this.loadVrManager=function(){this.vrManager=new VRManager,this.addObject(this.vrManager),this.vrManager.init(this.panoramaManager.camera),this.vrManager.object3D.visible=!1,this.vrManager.onVRModeEnabled=function(t){DomElements.zoomInButton.style.visibility=t?"hidden":"visible",DomElements.zoomOutButton.style.visibility=t?"hidden":"visible",e.panoramaManager.setTargetZoomFov(t?VRParams.fov:e.vrManager.previousFov)}},this.loadAppResources=function(e,t){var o;if(AppParams.isDisplayPanoramaFirst||AppParams.isSingleMode){var a=this.getDefaultHotSpot(e);o=PanoramaManager.getPrepareResourceUrls(a)}else o=StereoHouseManager.getPrepareResourceUrls(e);ResourcesLoader.prepareResources(o,t,function(e){DomElements.loadingProgressBar.style.width=e+"%"},function(){DomElements.loading.style.visibility="hidden",$(DomElements.loadingTip).text("加载失败")})},this.onAppResourcesLoaded=function(e){DomElements.welcome.style.visibility="hidden";var t=this.getDefaultHotSpot(e);if(AppParams.isSingleMode)return this.loadPanoramaManager(e),this.panoramaManager.loadPanoramaImage(t,!0,PanoramaParams.isAutoRotateWhenStart),this.loadThumbnailManager(e),this.thumbnailManager.loadThumbnail(),void this.thumbnailManager.selectThumbnail(t.ID);AppParams.isDisplayPanoramaFirst?(this.loadPanoramaManager(e),this.panoramaManager.loadPanoramaImage(t,!0,PanoramaParams.isAutoRotateWhenStart),this.loadFloorPlanManager(e),this.floorPlanManager.object3D.visible=!1,this.loadStereoHouseManager(e),this.stereoHouseManager.switchToSmallView(),this.loadThumbnailManager(e),this.thumbnailManager.loadThumbnail(),this.thumbnailManager.selectThumbnail(t.ID),this.bindControlEvents()):(this.loadPanoramaManager(e),this.panoramaManager.object3D.visible=!1,this.loadStereoHouseManager(e),this.loadFloorPlanManager(e),this.floorPlanManager.object3D.visible=!1,this.loadThumbnailManager(e),AppParams.alwaysDisplayThumbnail&&(this.thumbnailManager.loadThumbnail(),this.thumbnailManager.selectThumbnail(t.ID)),this.bindControlEvents(),this.stereoHouseManager.switchToLargeView()),AppParams.isPhone&&this.loadVrManager()}},VRHouseApp.prototype=new Sim.App,VRHouseApp.prototype.init=function(e,t){var o=this;this.houseData=t;var a=new THREE.WebGLRenderer;a.antialias=!0,a.sortObjects=!1,a.setPixelRatio(AppParams.isPhone?4:2),a.gammaInput=!0,a.gammaOutput=!0,a.autoClearColor=!1,a.setSize(Sim.screenWidth,Sim.screenHeight);var i={renderer:a,container:e,scene:new THREE.Scene};Sim.App.prototype.init.call(this,i),EventListener.listen(a.domElement,e),this.floorPlanSwitchBtnGroup=[DomElements.switch3DButton,DomElements.switch2DButton,DomElements.switchAutoButton],this.largeViewSwitchBtnGroup=[DomElements.largeViewSwitch2DButton,DomElements.largeViewSwitch3DButton],this.loadAppResources(t,function(){o.onAppResourcesLoaded(t)})},VRHouseApp.prototype.onWindowResize=function(){this.renderer.setSize(Sim.screenWidth,Sim.screenHeight),this.thumbnailManager&&this.thumbnailManager.onWindowResize()},runVRHouseApp=function(){function e(){AppParams.isPhone?(AppParams.isSingleMode||$(DomElements.switchVRButton).show(),$($(DomElements.largeViewSwitchController).removeClass("pc").addClass("phone").children()).removeClass("pc").addClass("phone"),$($(DomElements.controllerLeft).removeClass("pc").addClass("phone").children()).removeClass("pc").addClass("phone"),$(DomElements.vrHouseContainer).addClass("phone"),DomElements.zoomInButton.className="controller_right_phone",DomElements.zoomOutButton.className="controller_right_phone disabled",DomElements.zoomInButton.style.backgroundImage="url(textures/zoomInPhone.png)",DomElements.zoomOutButton.style.backgroundImage="url(textures/zoomOutPhone.png)"):$(DomElements.fullScreenButton).show(),AppParams.isSingleMode||(DomElements.controllerLeft.style.visibility="visible")}function t(e){if(!e.ClientVersion)for(var t in e.HotSpots){var o=e.HotSpots[t];if(o.ImagePath){var a=o.ImagePath.replace("PanoramaImages","PanoramaTileImages");a.indexOf("PanoramaTileImages")<0&&(a="PanoramaTileImages/"+a);var i=(a=a.substring(0,a.lastIndexOf(".")))+"_",n=["l.jpg","r.jpg","u.jpg","d.jpg","f.jpg","b.jpg"];o.TileImagesPath=[];for(var r in n)o.TileImagesPath[r]=i+n[r]}}}ResourcesLoader.getHouseViewData(function(o,a){if(o)if(document.title=o.Name,o.CoverImagePath&&""!==o.CoverImagePath&&(DomElements.welcome.style.backgroundImage="url('"+AppParams.housePathPrefix+o.CoverImagePath+"')"),0!==o.HotSpots.length){e(),t(o);var i=new VRHouseApp;i.init(DomElements.vrHouseContainer,o),i.run()}else $(DomElements.loadingTip).text("没有全景图片");else 404===a?$(DomElements.loadingTip).text("您要浏览的房子不存在"):-1===a?$(DomElements.loadingTip).text("数据格式错误"):$(DomElements.loadingTip).text("出错了，请刷新重试")})},runVRHouseApp();
